{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-6 py-8 max-w-2xl">
    <h1 class="text-2xl font-bold text-white mb-8">My Profile</h1>

    <!-- Profile Info -->
    <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl border border-gray-700/50 p-6 mb-6">
        <div class="flex items-center gap-4 mb-6">
            <div class="w-16 h-16 rounded-full
                {% if current_user.role == 'admin' %}bg-purple-600
                {% elif current_user.role == 'developer' %}bg-blue-600
                {% else %}bg-gray-600{% endif %}
                flex items-center justify-center text-white text-2xl font-medium">
                {{ current_user.display_name[0].upper() }}
            </div>
            <div>
                <h2 class="text-xl font-semibold text-white">{{ current_user.display_name }}</h2>
                <p class="text-gray-400">{{ current_user.email }}</p>
                <span class="inline-block mt-1 px-2 py-0.5 rounded text-xs font-medium
                    {% if current_user.role == 'admin' %}bg-purple-900/50 text-purple-300
                    {% elif current_user.role == 'developer' %}bg-blue-900/50 text-blue-300
                    {% else %}bg-gray-700 text-gray-300{% endif %}">
                    {{ current_user.role|capitalize }}
                </span>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
                <p class="text-gray-500">Member since</p>
                <p class="text-gray-300">{{ current_user.created_at.strftime('%B %d, %Y') if current_user.created_at else 'Unknown' }}</p>
            </div>
            <div>
                <p class="text-gray-500">Last login</p>
                <p class="text-gray-300">{{ current_user.last_login.strftime('%B %d, %Y %H:%M') if current_user.last_login else 'Never' }}</p>
            </div>
        </div>
    </div>

    <!-- Change Password -->
    <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl border border-gray-700/50 p-6 mb-6">
        <h3 class="text-lg font-semibold text-white mb-4">Change Password</h3>
        <form id="password-form" class="space-y-4">
            <div>
                <label for="current_password" class="block text-sm font-medium text-gray-300 mb-2">Current Password</label>
                <input type="password" id="current_password" name="current_password" required
                    class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label for="new_password" class="block text-sm font-medium text-gray-300 mb-2">New Password</label>
                <input type="password" id="new_password" name="new_password" required minlength="8"
                    class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label for="confirm_password" class="block text-sm font-medium text-gray-300 mb-2">Confirm New Password</label>
                <input type="password" id="confirm_password" name="confirm_password" required
                    class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div id="password-message" class="hidden p-3 rounded-lg text-sm"></div>
            <button type="submit"
                class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                Update Password
            </button>
        </form>
    </div>

    <!-- Active Sessions -->
    <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl border border-gray-700/50 p-6">
        <h3 class="text-lg font-semibold text-white mb-4">Active Sessions</h3>
        <div class="space-y-3">
            {% for session in sessions %}
            <div class="flex items-center justify-between bg-gray-900/50 rounded-lg p-3">
                <div>
                    <p class="text-gray-300 text-sm">
                        {% if session.user_agent %}
                        {{ session.user_agent[:60] }}{% if session.user_agent|length > 60 %}...{% endif %}
                        {% else %}
                        Unknown device
                        {% endif %}
                    </p>
                    <p class="text-gray-500 text-xs mt-1">
                        {{ session.ip_address or 'Unknown IP' }} &bull;
                        Created {{ session.created_at.strftime('%Y-%m-%d %H:%M') if session.created_at else 'Unknown' }}
                    </p>
                </div>
                <span class="text-xs text-gray-500">
                    Expires {{ session.expires_at.strftime('%Y-%m-%d') if session.expires_at else 'Unknown' }}
                </span>
            </div>
            {% else %}
            <p class="text-gray-500 text-sm">No active sessions</p>
            {% endfor %}
        </div>
    </div>
</div>

<script>
document.getElementById('password-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const messageDiv = document.getElementById('password-message');

    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;

    if (newPassword !== confirmPassword) {
        messageDiv.className = 'p-3 rounded-lg text-sm bg-red-900/30 border border-red-700/50 text-red-400';
        messageDiv.textContent = 'New passwords do not match';
        messageDiv.classList.remove('hidden');
        return;
    }

    const formData = new FormData(this);

    try {
        const response = await fetch('/profile/password', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();

        if (data.success) {
            messageDiv.className = 'p-3 rounded-lg text-sm bg-green-900/30 border border-green-700/50 text-green-400';
            messageDiv.textContent = 'Password changed successfully';
            this.reset();
        } else {
            messageDiv.className = 'p-3 rounded-lg text-sm bg-red-900/30 border border-red-700/50 text-red-400';
            messageDiv.textContent = data.detail || 'Failed to change password';
        }
        messageDiv.classList.remove('hidden');
    } catch (e) {
        messageDiv.className = 'p-3 rounded-lg text-sm bg-red-900/30 border border-red-700/50 text-red-400';
        messageDiv.textContent = 'Error: ' + e.message;
        messageDiv.classList.remove('hidden');
    }
});
</script>
{% endblock %}
