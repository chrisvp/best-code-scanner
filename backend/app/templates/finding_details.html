{% extends "base.html" %}

{% block head %}
<!-- Markdown rendering library -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/c.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/cpp.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/diff.min.js"></script>
{% endblock %}

{% block content %}
<!-- GitHub/GitLab-style diff viewer -->
<style>
    /* Diff table structure */
    .diff-table { width: 100%; border-collapse: collapse; font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace; font-size: 12px; }
    .diff-table td { padding: 0; vertical-align: top; }
    .diff-table pre { margin: 0; padding: 0 8px; white-space: pre-wrap; word-break: break-all; }

    /* Line numbers */
    .diff-line-num {
        width: 50px; min-width: 50px; padding: 0 8px; text-align: right;
        color: rgba(139, 148, 158, 0.6); background: rgba(22, 27, 34, 0.8);
        user-select: none; vertical-align: top; border-right: 1px solid #30363d;
    }
    .diff-line-num:hover { color: #c9d1d9; cursor: pointer; }

    /* Line content */
    .diff-line-content { padding: 0 8px; white-space: pre; overflow-x: auto; }

    /* Hunk header */
    .diff-hunk-header {
        background: rgba(56, 139, 253, 0.15); color: #8b949e;
        padding: 8px 12px; font-style: italic; border-top: 1px solid #30363d;
    }
    .diff-hunk-header td { padding: 4px 8px; }

    /* Addition (green) */
    .diff-add { background: rgba(46, 160, 67, 0.15); }
    .diff-add .diff-line-num { background: rgba(46, 160, 67, 0.25); color: #7ee787; }
    .diff-add .diff-line-content { color: #aff5b4; }
    .diff-add-word { background: rgba(46, 160, 67, 0.4); border-radius: 2px; }

    /* Deletion (red) */
    .diff-del { background: rgba(248, 81, 73, 0.15); }
    .diff-del .diff-line-num { background: rgba(248, 81, 73, 0.25); color: #f85149; }
    .diff-del .diff-line-content { color: #ffa198; }
    .diff-del-word { background: rgba(248, 81, 73, 0.4); border-radius: 2px; }

    /* Context lines */
    .diff-context { background: transparent; }
    .diff-context .diff-line-content { color: #c9d1d9; }

    /* Split view specific */
    .diff-split-view { display: flex; }
    .diff-split-pane { flex: 1; overflow: auto; border-right: 1px solid #30363d; }
    .diff-split-pane:last-child { border-right: none; }
    .diff-split-pane .diff-table { table-layout: fixed; }
    .diff-split-pane .diff-line-num { width: 45px; min-width: 45px; }

    /* Empty placeholder for alignment */
    .diff-empty { background: rgba(110, 118, 129, 0.1); }
    .diff-empty .diff-line-num { background: rgba(110, 118, 129, 0.15); }

    /* File header */
    .diff-file-header {
        background: #161b22; padding: 8px 12px; border-bottom: 1px solid #30363d;
        display: flex; align-items: center; justify-content: space-between;
    }
    .diff-file-path { font-family: ui-monospace, monospace; font-size: 12px; color: #c9d1d9; }
    .diff-stats { font-size: 12px; }
    .diff-stats-add { color: #3fb950; }
    .diff-stats-del { color: #f85149; }

    /* Expand context button */
    .diff-expand-btn {
        background: #21262d; border: 1px solid #30363d; border-radius: 4px;
        color: #8b949e; padding: 2px 8px; font-size: 11px; cursor: pointer;
        display: inline-flex; align-items: center; gap: 4px;
    }
    .diff-expand-btn:hover { background: #30363d; color: #c9d1d9; }
    .diff-expand-btn svg { width: 12px; height: 12px; }

    /* Expand row styling */
    .diff-expand-row { background: #161b22; }
    .diff-expand-row td { padding: 4px 8px; text-align: center; }
    .diff-expand-row .diff-line-num { background: #161b22; }

    /* Full file toggle */
    .diff-toolbar {
        background: #161b22; padding: 6px 12px; border-bottom: 1px solid #30363d;
        display: flex; align-items: center; justify-content: space-between; gap: 8px;
    }
    .diff-toolbar-btn {
        background: #21262d; border: 1px solid #30363d; border-radius: 4px;
        color: #8b949e; padding: 4px 10px; font-size: 12px; cursor: pointer;
        display: inline-flex; align-items: center; gap: 6px;
    }
    .diff-toolbar-btn:hover { background: #30363d; color: #c9d1d9; }
    .diff-toolbar-btn.active { background: #388bfd33; border-color: #388bfd; color: #58a6ff; }
    .diff-toolbar-btn svg { width: 14px; height: 14px; }

    /* Context amount selector */
    .diff-context-select {
        background: #21262d; border: 1px solid #30363d; border-radius: 4px;
        color: #c9d1d9; padding: 4px 8px; font-size: 12px;
    }
</style>
<!-- Markdown content styles -->
<style>
    .markdown-content h1 { font-size: 1.5rem; font-weight: 700; margin-top: 1rem; margin-bottom: 0.5rem; color: #f3f4f6; }
    .markdown-content h2 { font-size: 1.25rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; color: #f3f4f6; }
    .markdown-content h3 { font-size: 1.1rem; font-weight: 600; margin-top: 0.75rem; margin-bottom: 0.25rem; color: #e5e7eb; }
    .markdown-content h4 { font-size: 1rem; font-weight: 600; margin-top: 0.5rem; margin-bottom: 0.25rem; color: #d1d5db; }
    .markdown-content p { margin-bottom: 0.5rem; color: #d1d5db; }
    .markdown-content ul, .markdown-content ol { margin-left: 1.5rem; margin-bottom: 0.5rem; }
    .markdown-content li { margin-bottom: 0.25rem; }
    .markdown-content ul { list-style-type: disc; }
    .markdown-content ol { list-style-type: decimal; }
    .markdown-content code:not(pre code) { background: rgba(31, 41, 55, 0.8); padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.875em; color: #93c5fd; }
    .markdown-content pre { background: rgba(17, 24, 39, 0.8); padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.5rem 0; border: 1px solid rgba(55, 65, 81, 0.5); }
    .markdown-content pre code { background: transparent; padding: 0; color: #e5e7eb; }
    .markdown-content blockquote { border-left: 3px solid #4b5563; padding-left: 1rem; margin: 0.5rem 0; color: #9ca3af; }
    .markdown-content a { color: #60a5fa; text-decoration: underline; }
    .markdown-content strong { color: #f3f4f6; font-weight: 600; }
    .markdown-content hr { border-color: #374151; margin: 1rem 0; }
    .markdown-content table { width: 100%; border-collapse: collapse; margin: 0.5rem 0; }
    .markdown-content th, .markdown-content td { border: 1px solid #374151; padding: 0.5rem; text-align: left; }
    .markdown-content th { background: rgba(31, 41, 55, 0.5); }
</style>

<div class="flex h-full overflow-hidden" id="main-container">
    <!-- Left Panel: Finding Details -->
    <div id="left-panel" class="bg-gray-800/50 flex flex-col overflow-hidden" style="width: 70%; min-width: 300px;">
        <!-- Header -->
        <div class="p-4 border-b border-gray-700 bg-gray-800/80">
            <div class="flex items-center justify-between mb-3">
                <a href="/" class="text-gray-400 hover:text-white flex items-center gap-2 text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back to Dashboard
                </a>
                <div class="flex items-center gap-2">
                    <span class="text-xs px-2 py-1 rounded font-medium uppercase
                        {% if finding.severity == 'Critical' %}bg-red-500/20 text-red-400
                        {% elif finding.severity == 'High' %}bg-orange-500/20 text-orange-400
                        {% elif finding.severity == 'Medium' %}bg-yellow-500/20 text-yellow-400
                        {% elif finding.severity == 'Weakness' %}bg-gray-500/20 text-gray-400
                        {% else %}bg-blue-500/20 text-blue-400{% endif %}">
                        {{ finding.severity }}
                    </span>
                    {% if scan %}
                    <select id="rescan-profile-select" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-gray-300 focus:outline-none focus:border-blue-500">
                        <option value="">No Profile</option>
                        {% for profile in profiles %}
                        <option value="{{ profile.id }}">{{ profile.name }}</option>
                        {% endfor %}
                    </select>
                    <button onclick="rescanFile()" id="rescan-btn" class="text-xs px-2 py-1 rounded font-medium bg-blue-600/20 text-blue-400 hover:bg-blue-600/40 transition-colors flex items-center gap-1" title="Start a new scan with only this file">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                        </svg>
                        Rescan File
                    </button>
                    {% endif %}
                    <button onclick="reparseFinding()" id="reparse-btn" class="text-xs px-2 py-1 rounded font-medium bg-orange-600/20 text-orange-400 hover:bg-orange-600/40 transition-colors flex items-center gap-1" title="Use cleanup model to reparse malformed data">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Reparse
                    </button>
                    {% if scan %}
                    <div class="flex items-center gap-1">
                        <select id="agent-model-select" class="text-xs px-1.5 py-1 rounded bg-slate-700 text-gray-300 border border-slate-600 focus:outline-none focus:ring-1 focus:ring-purple-500">
                            <option value="">Auto</option>
                            {% for model in models %}
                            <option value="{{ model.id }}">{{ model.name }}</option>
                            {% endfor %}
                        </select>
                        <button onclick="agentVerify()" id="agent-verify-btn" class="text-xs px-2 py-1 rounded font-medium bg-purple-600/20 text-purple-400 hover:bg-purple-600/40 transition-colors flex items-center gap-1" title="Run agent-based deep verification">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            Agent Verify
                        </button>
                    </div>
                    {% endif %}
                    <button onclick="deleteFinding()" class="text-xs px-2 py-1 rounded font-medium bg-red-600/20 text-red-400 hover:bg-red-600/40 transition-colors flex items-center gap-1" title="Delete this finding">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Delete
                    </button>
                </div>
            </div>
            <h1 class="text-xl font-bold text-white mb-2">Finding #{{ finding.id }}</h1>
            <div class="flex flex-wrap items-center gap-2 text-sm">
                {% if finding.category %}
                <span class="px-2 py-0.5 rounded bg-gray-700 text-gray-300">{{ finding.category }}</span>
                {% endif %}
                {% if scan %}
                <span class="px-2 py-0.5 rounded bg-blue-500/10 text-blue-400 border border-blue-500/20">Scan #{{ scan.id }}</span>
                {% elif mr_review %}
                <span class="px-2 py-0.5 rounded bg-purple-500/10 text-purple-400 border border-purple-500/20">MR Review #{{ mr_review.id }}</span>
                {% endif %}
                {% if finding.cvss_score %}
                <span class="px-2 py-0.5 rounded bg-red-500/10 text-red-400">CVSS: {{ finding.cvss_score }}</span>
                {% endif %}
                {% if finding.confidence_score %}
                <span class="px-2 py-0.5 rounded bg-green-500/10 text-green-400">Confidence: {{ "%.0f"|format(finding.confidence_score * 100) }}%</span>
                {% endif %}
            </div>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-4">
            <!-- Detection Metadata -->
            <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                <h3 class="text-sm font-medium text-gray-300 mb-3 flex items-center gap-2">
                    <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    Detection Info
                </h3>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <!-- Finding ID -->
                    <div>
                        <span class="text-gray-500">Finding ID:</span>
                        <span class="text-gray-300 ml-2 font-mono">#{{ finding.id }}</span>
                    </div>

                    <!-- Detection Time -->
                    <div>
                        <span class="text-gray-500">Enriched:</span>
                        <span class="text-gray-300 ml-2" title="When the finding completed the full scan pipeline">
                            {{ finding.detected_at.strftime('%Y-%m-%d %H:%M') if finding.detected_at else 'N/A' }}
                        </span>
                    </div>

                    <!-- Status -->
                    <div>
                        <span class="text-gray-500">Status:</span>
                        <span class="ml-2 text-xs px-2 py-0.5 rounded font-medium
                            {% if finding.status == 'VERIFIED' %}bg-green-500/20 text-green-400
                            {% elif finding.status == 'FP' %}bg-red-500/20 text-red-400
                            {% elif finding.status == 'FIXED' %}bg-blue-500/20 text-blue-400
                            {% elif finding.status == 'IGNORED' %}bg-gray-500/20 text-gray-400
                            {% else %}bg-yellow-500/20 text-yellow-400{% endif %}">
                            {{ finding.status }}
                        </span>
                    </div>

                    <!-- Confidence Score -->
                    {% if finding.confidence_score %}
                    <div>
                        <span class="text-gray-500">Confidence:</span>
                        <span class="text-gray-300 ml-2">{{ "%.1f"|format(finding.confidence_score) }}%</span>
                    </div>
                    {% endif %}

                    <!-- CVSS Score -->
                    {% if finding.cvss_score %}
                    <div>
                        <span class="text-gray-500">CVSS Score:</span>
                        <span class="ml-2 text-xs px-2 py-0.5 rounded font-medium
                            {% if finding.cvss_score >= 9.0 %}bg-red-500/20 text-red-400
                            {% elif finding.cvss_score >= 7.0 %}bg-orange-500/20 text-orange-400
                            {% elif finding.cvss_score >= 4.0 %}bg-yellow-500/20 text-yellow-400
                            {% else %}bg-blue-500/20 text-blue-400{% endif %}">
                            {{ "%.1f"|format(finding.cvss_score) }}
                        </span>
                    </div>
                    {% endif %}

                    <!-- Source (Scan or MR) -->
                    {% if scan %}
                    <div class="col-span-2">
                        <span class="text-gray-500">Source:</span>
                        <span class="text-blue-400 ml-2">
                            <a href="/" class="hover:underline">Scan #{{ scan.id }}</a>
                            <span class="text-gray-600 mx-2">•</span>
                            <span class="text-gray-400">{{ scan.status }}</span>
                        </span>
                    </div>
                    <div class="col-span-2">
                        <span class="text-gray-500">Scan Target:</span>
                        <span class="text-gray-300 ml-2 font-mono text-xs break-all">{{ scan.target_url or 'N/A' }}</span>
                    </div>
                    {% endif %}

                    {% if mr_review %}
                    <div class="col-span-2">
                        <span class="text-gray-500">Source:</span>
                        <span class="text-purple-400 ml-2">
                            <a href="/mr-reviews" class="hover:underline">MR Review #{{ mr_review.id }}</a>
                            <span class="text-gray-600 mx-2">•</span>
                            <span class="text-gray-400">!{{ mr_review.mr_iid }}</span>
                            <span class="text-gray-600 mx-2">•</span>
                            <span class="text-gray-400">{{ mr_review.status }}</span>
                        </span>
                    </div>
                    <div class="col-span-2">
                        <span class="text-gray-500">MR Title:</span>
                        <span class="text-gray-300 ml-2">{{ mr_review.mr_title or 'N/A' }}</span>
                    </div>
                    {% endif %}

                    <!-- Status Change Info -->
                    {% if finding.status_changed_at %}
                    <div class="col-span-2 pt-2 border-t border-gray-700/50">
                        <span class="text-gray-500 text-xs">Status changed:</span>
                        <span class="text-gray-400 ml-2 text-xs">
                            {{ finding.status_changed_at.strftime('%Y-%m-%d %H:%M') }}
                            {% if finding.status_changed_by %}
                            by {{ finding.status_changed_by.username }}
                            {% endif %}
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Provenance & Verification History -->
            {% if provenance and (provenance.votes or provenance.agent_sessions or provenance.draft) %}
            <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                <h3 class="text-sm font-medium text-gray-300 mb-3 flex items-center gap-2">
                    <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Provenance & Verification
                </h3>
                
                <div class="space-y-4">
                    <!-- Discovery Phase -->
                    {% if provenance.draft and provenance.draft.source_models %}
                    <div>
                        <h4 class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">1. Discovery</h4>
                        <div class="flex flex-wrap gap-2">
                            {% for model in provenance.draft.source_models %}
                            <span class="text-xs px-2 py-1 rounded bg-blue-500/10 text-blue-400 border border-blue-500/20 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                                {{ model }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Verification Phase -->
                    {% if provenance.votes %}
                    <div>
                        <h4 class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">2. Consensus Verification</h4>
                        <div class="grid grid-cols-1 gap-2">
                            {% for vote in provenance.votes %}
                            <details class="bg-gray-800 border border-gray-700 rounded text-xs">
                                <summary class="flex items-center justify-between p-2 cursor-pointer hover:bg-gray-750 transition-colors">
                                    <span class="text-gray-300 font-medium">{{ vote.model_name }}</span>
                                    <div class="flex items-center gap-2">
                                        <span class="font-medium
                                            {% if vote.decision == 'REAL' or vote.decision == 'VERIFY' %}text-green-400
                                            {% elif vote.decision == 'FALSE_POSITIVE' or vote.decision == 'REJECT' %}text-red-400
                                            {% elif vote.decision == 'WEAKNESS' %}text-yellow-400
                                            {% elif vote.decision == 'NEEDS_VERIFIED' %}text-purple-400
                                            {% else %}text-gray-400{% endif %}">
                                            {{ vote.decision }}
                                        </span>
                                        <span class="text-gray-500">{{ vote.confidence }}%</span>
                                        <svg class="w-3 h-3 text-gray-500 transition-transform details-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </summary>
                                {% if vote.reasoning %}
                                <div class="px-3 pb-2 pt-1 text-gray-400 text-xs border-t border-gray-700/50 whitespace-pre-wrap">{{ vote.reasoning }}</div>
                                {% endif %}
                            </details>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Agent Verification Phase -->
                    {% if provenance.agent_sessions %}
                    <div>
                        <h4 class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">3. Agent Verification</h4>
                        <div class="space-y-2">
                            {% for session in provenance.agent_sessions %}
                            <div class="p-2 rounded bg-gray-800 border border-gray-700 text-xs">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-purple-300 font-medium">{{ session.model_name }}</span>
                                    <span class="text-gray-500">{{ session.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="
                                        {% if session.verdict == 'VERIFIED' or session.verdict == 'TRUE POSITIVE' %}text-green-400
                                        {% elif session.verdict == 'REJECTED' or session.verdict == 'FALSE POSITIVE' %}text-red-400
                                        {% else %}text-gray-400{% endif %} font-bold">
                                        {{ session.verdict or 'IN PROGRESS' }}
                                    </span>
                                    <span class="text-gray-400">{{ session.total_steps }} steps</span>
                                    {% if session.confidence %}
                                    <span class="text-gray-400">Conf: {{ session.confidence }}%</span>
                                    {% endif %}
                                </div>
                                {% if session.reasoning %}
                                <div class="mt-1.5 pt-1.5 border-t border-gray-700/50 text-gray-400 line-clamp-2" title="{{ session.reasoning }}">
                                    {{ session.reasoning }}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Location -->
            <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                <h3 class="text-sm font-medium text-gray-300 mb-2 flex items-center gap-2">
                    <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Location
                </h3>
                <div class="font-mono text-sm">
                    <span class="text-blue-400">{{ finding.file_path }}</span>
                    {% if finding.line_number %}
                    <span class="text-gray-600">:</span>
                    <span class="text-green-400">{{ finding.line_number }}</span>
                    {% endif %}
                </div>
            </div>

            <!-- Description -->
            <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                <h3 class="text-sm font-medium text-gray-300 mb-2 flex items-center gap-2">
                    <svg class="w-4 h-4 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Description
                </h3>
                <p class="text-gray-300 text-sm leading-relaxed">{{ finding.description }}</p>
            </div>

            <!-- Side-by-Side Code Diff -->
            <div class="bg-gray-900/50 rounded-lg border border-gray-700 overflow-hidden">
                <div class="flex items-center justify-between p-3 border-b border-gray-700 bg-gray-800/50">
                    <div class="flex items-center gap-3">
                        <h3 class="text-sm font-medium text-gray-300 flex items-center gap-2">
                            <svg class="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            Code Comparison
                        </h3>
                        <!-- View Toggle -->
                        <div class="flex items-center bg-gray-700 rounded-lg p-0.5">
                            <button id="view-split-btn" onclick="setDiffView('split')" class="px-2 py-1 text-xs rounded-md transition-colors bg-gray-600 text-white" title="Side-by-side view">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7"></path>
                                </svg>
                            </button>
                            <button id="view-unified-btn" onclick="setDiffView('unified')" class="px-2 py-1 text-xs rounded-md transition-colors text-gray-400 hover:text-white" title="Unified diff view">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                </svg>
                            </button>
                        </div>
                        <!-- Sync Scroll Toggle -->
                        <label class="flex items-center gap-1.5 text-xs text-gray-400 cursor-pointer" title="Synchronize scrolling between panes">
                            <input type="checkbox" id="sync-scroll-toggle" checked onchange="toggleSyncScroll()" class="w-3.5 h-3.5 rounded bg-gray-700 border-gray-600 text-cyan-500 focus:ring-cyan-500">
                            Sync
                        </label>
                    </div>
                    <!-- Generate Fix Buttons -->
                    <div class="flex items-center gap-2">
                        <select id="fix-model-select" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-gray-300 focus:outline-none focus:border-blue-500">
                            {% for model in models %}
                            <option value="{{ model.id }}" {% if global_settings.get('default_chat_model_id') == model.id|string %}selected{% endif %}>{{ model.name }}</option>
                            {% endfor %}
                        </select>
                        <button id="quick-fix-btn" onclick="generateQuickFix()"
                            class="px-3 py-1 bg-green-600 hover:bg-green-500 text-white rounded text-xs font-medium transition-colors flex items-center gap-1"
                            title="Fast single-shot fix with file context">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            Quick Fix
                        </button>
                        <button id="agent-fix-btn" onclick="generateAgentFix()"
                            class="px-3 py-1 bg-purple-600 hover:bg-purple-500 text-white rounded text-xs font-medium transition-colors flex items-center gap-1"
                            title="Agentic fix with codebase exploration (slower but more accurate)">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            Agent Fix
                        </button>
                    </div>
                </div>

                <!-- Split Diff View (default) -->
                <div id="split-diff-view" class="grid grid-cols-2 divide-x divide-gray-700">
                    <!-- Vulnerable Code with Context -->
                    <div class="flex flex-col">
                        <div class="px-3 py-2 bg-red-900/20 border-b border-gray-700 flex items-center gap-2">
                            <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <span class="text-xs font-medium text-red-400">Vulnerable Code</span>
                            <span id="code-context-info" class="text-xs text-gray-500 ml-auto">Line {{ finding.line_number or '?' }}</span>
                            <button id="toggle-full-file-btn" onclick="toggleFullFile()" class="diff-expand-btn ml-2" title="Load full file">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                                </svg>
                                <span id="toggle-full-file-text">Full file</span>
                            </button>
                        </div>
                        <div id="vulnerable-code-container" class="overflow-auto bg-gray-900 flex-1 font-mono text-xs" style="max-height: 500px;">
                            <!-- Will be populated by JS with line numbers, syntax highlighting, and vulnerable line marked -->
                            <div class="p-3 text-gray-500">Loading full file...</div>
                        </div>
                    </div>

                    <!-- Fixed Code with Navigation -->
                    <div class="flex flex-col">
                        <div class="px-3 py-2 bg-green-900/20 border-b border-gray-700 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="text-xs font-medium text-green-400">Suggested Fix</span>
                            </div>
                            <!-- Fix Navigation -->
                            <div id="fix-nav" class="hidden flex items-center gap-2">
                                <button onclick="prevFix()" class="p-1 hover:bg-gray-700 rounded" title="Previous fix">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                    </svg>
                                </button>
                                <span id="fix-counter" class="text-xs text-gray-400">1/1</span>
                                <button onclick="nextFix()" class="p-1 hover:bg-gray-700 rounded" title="Next fix">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                                <span id="fix-type-badge" class="text-xs px-1.5 py-0.5 rounded bg-gray-700 text-gray-300"></span>
                            </div>
                        </div>
                        <div id="fixed-code-container" class="flex-1 relative">
                            {% if finding.corrected_code %}
                            <pre class="p-3 text-xs overflow-x-auto bg-gray-900 h-full"><code id="fixed-code" class="language-{{ 'python' if finding.file_path.endswith('.py') else 'cpp' if finding.file_path.endswith('.cpp') else 'c' }}">{{ finding.corrected_code | strip_code }}</code></pre>
                            {% else %}
                            <div id="no-fix-placeholder" class="p-4 text-center text-gray-500 h-full flex flex-col items-center justify-center">
                                <svg class="w-8 h-8 mb-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                <p class="text-xs">No fix generated yet</p>
                                <p class="text-xs text-gray-600 mt-1">Click "Quick Fix" or "Agent Fix" to generate one</p>
                            </div>
                            {% endif %}
                            <!-- Loading indicator -->
                            <div id="fix-loading" class="hidden absolute inset-0 bg-gray-900/80 flex items-center justify-center">
                                <div class="flex flex-col items-center gap-2">
                                    <div class="animate-spin w-8 h-8 border-2 border-green-500 border-t-transparent rounded-full"></div>
                                    <span id="fix-loading-text" class="text-xs text-gray-400">Generating fix...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Unified Diff View (hidden by default) -->
                <div id="unified-diff-view" class="hidden">
                    <div class="px-3 py-2 bg-gray-800/50 border-b border-gray-700 flex items-center gap-2">
                        <svg class="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                        <span class="text-xs font-medium text-gray-300">Unified Diff</span>
                        <span class="text-xs text-gray-500 ml-auto">
                            <span class="text-red-400">- removed</span> / <span class="text-green-400">+ added</span>
                        </span>
                    </div>
                    <div id="unified-diff-container" class="overflow-auto bg-gray-900 font-mono text-xs p-3" style="max-height: 500px;">
                        <div class="text-gray-500">Generate a fix to see the unified diff...</div>
                    </div>
                </div>
            </div>

            <!-- Vulnerability Details -->
            {% if finding.vulnerability_details %}
            <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                <h3 class="text-sm font-medium text-gray-300 mb-2 flex items-center gap-2">
                    <svg class="w-4 h-4 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    Vulnerability Details
                </h3>
                <div class="text-sm leading-relaxed markdown-content" data-markdown='{{ finding.vulnerability_details | tojson }}'></div>
            </div>
            {% endif %}

            <!-- Proof of Concept -->
            {% if finding.proof_of_concept %}
            <div class="bg-gray-900/50 rounded-lg border border-gray-700 overflow-hidden">
                <h3 class="text-sm font-medium text-gray-300 p-3 border-b border-gray-700 flex items-center gap-2">
                    <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    Proof of Concept
                </h3>
                <pre class="p-3 text-xs text-gray-300 overflow-x-auto bg-gray-900"><code id="poc-code">{{ finding.proof_of_concept | strip_code }}</code></pre>
            </div>
            {% endif %}

            <!-- Remediation Steps -->
            {% if finding.remediation_steps %}
            <div class="bg-green-900/20 rounded-lg p-4 border border-green-700/50">
                <h3 class="text-sm font-medium text-green-300 mb-2 flex items-center gap-2">
                    <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                    </svg>
                    Remediation Steps
                </h3>
                <div class="text-sm leading-relaxed markdown-content" data-markdown='{{ finding.remediation_steps | tojson }}'></div>
            </div>
            {% elif finding.remediation %}
            <div class="bg-green-900/20 rounded-lg p-4 border border-green-700/50">
                <h3 class="text-sm font-medium text-green-300 mb-2 flex items-center gap-2">
                    <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Recommended Fix
                </h3>
                <div class="text-sm leading-relaxed markdown-content" data-markdown='{{ finding.remediation | tojson }}'></div>
            </div>
            {% endif %}

            <!-- References -->
            {% if finding.references %}
            <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                <h3 class="text-sm font-medium text-gray-300 mb-2 flex items-center gap-2">
                    <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                    </svg>
                    References
                </h3>
                <div class="text-sm leading-relaxed markdown-content" data-markdown='{{ finding.references | tojson }}'></div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Resizable Divider -->
    <div id="resize-handle" class="w-1 bg-gray-700 hover:bg-blue-500 cursor-col-resize flex-shrink-0 relative group transition-colors">
        <div class="absolute inset-y-0 -left-1 -right-1"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-4 h-8 bg-gray-600 group-hover:bg-blue-400 rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
            <svg class="w-2 h-4 text-gray-300" fill="currentColor" viewBox="0 0 6 16">
                <circle cx="1" cy="4" r="1"/>
                <circle cx="1" cy="8" r="1"/>
                <circle cx="1" cy="12" r="1"/>
                <circle cx="5" cy="4" r="1"/>
                <circle cx="5" cy="8" r="1"/>
                <circle cx="5" cy="12" r="1"/>
            </svg>
        </div>
    </div>

    <!-- Right Panel: AI Chat -->
    <div id="right-panel" class="bg-gray-900 flex flex-col overflow-hidden flex-1" style="min-width: 300px;">
        <!-- Chat Header -->
        <div class="p-4 border-b border-gray-700 bg-gray-800/50">
            <div class="flex items-center justify-between mb-1">
                <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                    AI Security Assistant
                </h2>
                <div class="flex items-center gap-2">
                    <button onclick="retryLastMessage()" id="retry-btn" class="hidden px-2 py-1 bg-yellow-600/20 hover:bg-yellow-600/40 text-yellow-400 rounded text-xs font-medium transition-colors flex items-center gap-1" title="Retry last message (discard previous response)">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Retry
                    </button>
                    <button onclick="clearChat()" id="clear-chat-btn" class="px-2 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded text-xs font-medium transition-colors flex items-center gap-1" title="Clear chat history">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Clear
                    </button>
                    <select id="chat-model-select" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-gray-300 focus:outline-none focus:border-blue-500">
                        {% for model in models %}
                        <option value="{{ model.id }}" {% if global_settings.get('default_chat_model_id') == model.id|string %}selected{% endif %}>{{ model.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <p class="text-sm text-gray-400">Ask questions about this vulnerability or request alternative fixes</p>
        </div>

        <!-- Chat Messages -->
        <div id="chat-messages" class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-4">
            <!-- Welcome Message -->
            <div id="welcome-message" class="flex gap-3">
                <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center shrink-0">
                    <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                </div>
                <div class="flex-1">
                    <div class="bg-gray-800 rounded-lg p-3 border border-gray-700">
                        <p class="text-sm text-gray-300">
                            I'm here to help you understand and fix this <strong class="text-{{ 'red' if finding.severity == 'Critical' else 'orange' if finding.severity == 'High' else 'yellow' if finding.severity == 'Medium' else 'blue' }}-400">{{ finding.severity }}</strong> severity vulnerability.
                        </p>
                        <p class="text-sm text-gray-400 mt-2">You can ask me:</p>
                        <ul class="text-sm text-gray-400 mt-1 list-disc list-inside space-y-1">
                            <li>Explain why this is dangerous</li>
                            <li>Show me a different way to fix this</li>
                            <li>What are the attack vectors?</li>
                            <li>Generate a unit test for the fix</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="p-4 border-t border-gray-700 bg-gray-800/30">
            <form id="chat-form" onsubmit="sendMessage(event)" class="flex gap-3">
                <input type="text" id="chat-input" placeholder="Ask about this vulnerability..."
                    class="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-4 py-2.5 text-sm text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500">
                <button type="submit" id="send-btn"
                    class="px-4 py-2.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors flex items-center gap-2 text-sm font-medium">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                    Send
                </button>
            </form>
            <div class="flex gap-2 mt-3 flex-wrap">
                <button onclick="askQuestion('Explain why this vulnerability is dangerous')"
                    class="text-xs px-3 py-1.5 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors border border-gray-700">
                    Why is this dangerous?
                </button>
                <button onclick="askQuestion('Show me an alternative fix for this code')"
                    class="text-xs px-3 py-1.5 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors border border-gray-700">
                    Alternative fix
                </button>
                <button onclick="askQuestion('Generate a unit test for the fixed code')"
                    class="text-xs px-3 py-1.5 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors border border-gray-700">
                    Generate test
                </button>
                <button onclick="askQuestion('What are the potential attack vectors for this vulnerability?')"
                    class="text-xs px-3 py-1.5 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors border border-gray-700">
                    Attack vectors
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const findingId = {{ finding.id }};
const scanId = {{ scan.id if scan else 'null' }};
const filePath = {{ finding.file_path | tojson }};
let chatHistory = [];
let allFixes = [];
let currentFixIndex = 0;
let lastUserMessage = null;
let syncScrollEnabled = true;
let currentDiffView = 'split';
let originalFileLines = [];  // Store original file lines for diff generation
let originalFileContent = []; // Store {number, content} for each line of the original file
let diffContextLines = 3;  // Number of context lines to show (GitHub default is 3)
let showFullFile = false;  // Whether to show entire file with diff
let currentParsedDiff = null;  // Cache parsed diff data

// ============ Diff View Functions ============

// Toggle between split and unified diff views
function setDiffView(view) {
    currentDiffView = view;
    const splitView = document.getElementById('split-diff-view');
    const unifiedView = document.getElementById('unified-diff-view');
    const splitBtn = document.getElementById('view-split-btn');
    const unifiedBtn = document.getElementById('view-unified-btn');

    if (view === 'split') {
        splitView.classList.remove('hidden');
        unifiedView.classList.add('hidden');
        splitBtn.className = 'px-2 py-1 text-xs rounded-md transition-colors bg-gray-600 text-white';
        unifiedBtn.className = 'px-2 py-1 text-xs rounded-md transition-colors text-gray-400 hover:text-white';
        // Re-render split view for diff files when switching back
        const currentFix = allFixes[currentFixIndex];
        if (currentFix && currentFix.fix_type === 'diff' && currentFix.code) {
            displayDiffInSplitView(currentFix.code);
        }
    } else {
        splitView.classList.add('hidden');
        unifiedView.classList.remove('hidden');
        splitBtn.className = 'px-2 py-1 text-xs rounded-md transition-colors text-gray-400 hover:text-white';
        unifiedBtn.className = 'px-2 py-1 text-xs rounded-md transition-colors bg-gray-600 text-white';
        // Generate unified diff when switching to that view
        // For diff files, use the raw diff content; for regular fixes, compute diff
        const currentFix = allFixes[currentFixIndex];
        if (currentFix && currentFix.fix_type === 'diff' && currentFix.code) {
            displayDiffInUnifiedView(currentFix.code);
        } else {
            generateUnifiedDiff();
        }
    }

    // Save preference
    localStorage.setItem('diffViewPreference', view);
}

// Toggle synchronized scrolling
function toggleSyncScroll() {
    syncScrollEnabled = document.getElementById('sync-scroll-toggle').checked;
    localStorage.setItem('syncScrollEnabled', syncScrollEnabled);
}

// Setup synchronized scrolling between panes
function setupSyncScroll() {
    const leftPane = document.getElementById('vulnerable-code-container');
    const rightPane = document.getElementById('fixed-code-container');

    if (!leftPane || !rightPane) return;

    let isSyncing = false;

    function syncScroll(source, target) {
        if (!syncScrollEnabled || isSyncing) return;
        isSyncing = true;

        // Calculate scroll percentage
        const scrollPercentage = source.scrollTop / (source.scrollHeight - source.clientHeight);
        target.scrollTop = scrollPercentage * (target.scrollHeight - target.clientHeight);

        setTimeout(() => { isSyncing = false; }, 10);
    }

    leftPane.addEventListener('scroll', () => syncScroll(leftPane, rightPane));
    rightPane.addEventListener('scroll', () => syncScroll(rightPane, leftPane));
}

// Generate unified diff from original and fixed code
function generateUnifiedDiff() {
    const container = document.getElementById('unified-diff-container');
    if (!container) return;

    // Get current fix
    if (allFixes.length === 0) {
        container.textContent = 'Generate a fix to see the unified diff...';
        return;
    }

    const fixCode = allFixes[currentFixIndex]?.code || '';
    if (!fixCode) {
        container.textContent = 'No fix code available';
        return;
    }

    // Get original code from the vulnerable-code-container
    const vulnContainer = document.getElementById('vulnerable-code-container');
    let originalCode = '';

    // Extract text from the table if it exists
    const rows = vulnContainer.querySelectorAll('tr');
    if (rows.length > 0) {
        originalCode = Array.from(rows).map(row => {
            const codeCell = row.querySelector('td:last-child');
            return codeCell ? codeCell.textContent : '';
        }).join('\n');
    }

    if (!originalCode) {
        container.textContent = 'Cannot generate diff: original code not loaded';
        return;
    }

    // Generate simple line-by-line diff
    const origLines = originalCode.split('\n');
    const fixLines = fixCode.split('\n');

    // Use a simple diff algorithm
    const diff = computeSimpleDiff(origLines, fixLines);

    // Render the diff - using DOM methods for safety
    container.textContent = '';  // Clear previous content

    diff.forEach((line, idx) => {
        const lineDiv = document.createElement('div');
        lineDiv.className = 'whitespace-pre';

        if (line.type === 'removed') {
            lineDiv.className += ' bg-red-900/30 text-red-300';
            lineDiv.textContent = '- ' + line.content;
        } else if (line.type === 'added') {
            lineDiv.className += ' bg-green-900/30 text-green-300';
            lineDiv.textContent = '+ ' + line.content;
        } else {
            lineDiv.className += ' text-gray-400';
            lineDiv.textContent = '  ' + line.content;
        }

        container.appendChild(lineDiv);
    });
}

// Simple diff algorithm (good enough for code comparison)
function computeSimpleDiff(oldLines, newLines) {
    const result = [];
    const maxLen = Math.max(oldLines.length, newLines.length);

    // Simple line-by-line comparison with context
    // For a more accurate diff, we'd use Myers diff algorithm
    let i = 0, j = 0;

    while (i < oldLines.length || j < newLines.length) {
        if (i >= oldLines.length) {
            // Remaining lines are additions
            result.push({ type: 'added', content: newLines[j] });
            j++;
        } else if (j >= newLines.length) {
            // Remaining lines are removals
            result.push({ type: 'removed', content: oldLines[i] });
            i++;
        } else if (oldLines[i] === newLines[j]) {
            // Lines match
            result.push({ type: 'context', content: oldLines[i] });
            i++;
            j++;
        } else {
            // Lines differ - look ahead to find matches
            let foundMatch = false;

            // Look for oldLines[i] in upcoming newLines
            for (let k = j + 1; k < Math.min(j + 5, newLines.length); k++) {
                if (oldLines[i] === newLines[k]) {
                    // Insert additions before the match
                    for (let m = j; m < k; m++) {
                        result.push({ type: 'added', content: newLines[m] });
                    }
                    j = k;
                    foundMatch = true;
                    break;
                }
            }

            if (!foundMatch) {
                // Look for newLines[j] in upcoming oldLines
                for (let k = i + 1; k < Math.min(i + 5, oldLines.length); k++) {
                    if (newLines[j] === oldLines[k]) {
                        // Insert removals before the match
                        for (let m = i; m < k; m++) {
                            result.push({ type: 'removed', content: oldLines[m] });
                        }
                        i = k;
                        foundMatch = true;
                        break;
                    }
                }
            }

            if (!foundMatch) {
                // No match found - treat as removal + addition
                result.push({ type: 'removed', content: oldLines[i] });
                result.push({ type: 'added', content: newLines[j] });
                i++;
                j++;
            }
        }
    }

    return result;
}

// Rescan just this file (for testing/tuning)
async function rescanFile() {
    if (!scanId) {
        alert('Cannot rescan: no source scan available');
        return;
    }

    const btn = document.getElementById('rescan-btn');
    const profileSelect = document.getElementById('rescan-profile-select');
    const profileId = profileSelect ? profileSelect.value : '';
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `
        <svg class="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="30 60"></circle>
        </svg>
        Starting...
    `;

    try {
        // Extract just the filename from the full path for the scan name
        const fileName = filePath.split('/').pop();

        // Strip sandbox/{scan_id}/ prefix from file path for filter matching
        // e.g., "sandbox/10/BootManagerDxe/File.c" -> "BootManagerDxe/File.c"
        // Also handle absolute paths: "/home/.../sandbox/10/File.c" -> "File.c"
        let filterPath = filePath;
        const sandboxMatch = filePath.match(/\/sandbox\/\d+\/(.+)$/);
        if (sandboxMatch) {
            filterPath = sandboxMatch[1];
        }

        const formData = new FormData();
        formData.append('copy_from_scan_id', scanId);
        formData.append('file_filter', filterPath);  // Limit to just this file (relative path)
        formData.append('scan_name', fileName);      // Use filename as scan name
        if (profileId) {
            formData.append('profile_id', profileId);
        }

        const response = await fetch('/scan/start', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            // Redirect to dashboard to see the new scan
            window.location.href = '/';
        } else {
            const text = await response.text();
            alert('Failed to start scan: ' + text);
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        }
    } catch (err) {
        alert('Error: ' + err.message);
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
}

// Resizable panel functionality
(function initResizer() {
    const container = document.getElementById('main-container');
    const leftPanel = document.getElementById('left-panel');
    const handle = document.getElementById('resize-handle');
    let isResizing = false;

    handle.addEventListener('mousedown', (e) => {
        isResizing = true;
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;

        const containerRect = container.getBoundingClientRect();
        const newWidth = e.clientX - containerRect.left;
        const containerWidth = containerRect.width;

        // Enforce min/max constraints (300px min, leave at least 300px for right panel)
        const minWidth = 300;
        const maxWidth = containerWidth - 300 - handle.offsetWidth;

        if (newWidth >= minWidth && newWidth <= maxWidth) {
            leftPanel.style.width = newWidth + 'px';
        }
    });

    document.addEventListener('mouseup', () => {
        if (isResizing) {
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            // Save preference to localStorage
            localStorage.setItem('findingDetailsPanelWidth', leftPanel.style.width);
        }
    });

    // Restore saved width
    const savedWidth = localStorage.getItem('findingDetailsPanelWidth');
    if (savedWidth) {
        leftPanel.style.width = savedWidth;
    }
})();

// Chat persistence helpers
const chatStorageKey = `findingChat_${findingId}`;

function saveChatHistory() {
    localStorage.setItem(chatStorageKey, JSON.stringify(chatHistory));
}

function loadChatHistory() {
    try {
        const saved = localStorage.getItem(chatStorageKey);
        if (saved) {
            chatHistory = JSON.parse(saved);
            // Rebuild the chat UI from history
            chatHistory.forEach(msg => {
                addMessage(msg.role, msg.content, false); // false = don't save again
            });
            if (chatHistory.length >= 2) {
                // Find the last user message for retry functionality
                for (let i = chatHistory.length - 1; i >= 0; i--) {
                    if (chatHistory[i].role === 'user') {
                        lastUserMessage = chatHistory[i].content;
                        break;
                    }
                }
            }
            updateRetryButton();
        }
    } catch (e) {
        console.error('Failed to load chat history:', e);
    }
}

// Clear chat history
function clearChat() {
    chatHistory = [];
    lastUserMessage = null;
    localStorage.removeItem(chatStorageKey);
    const messagesDiv = document.getElementById('chat-messages');
    // Remove all chat messages (elements with .chat-message class), keep welcome message
    const chatMessages = messagesDiv.querySelectorAll('.chat-message');
    chatMessages.forEach(msg => msg.remove());
    updateRetryButton();
}

// Retry the last message (discard previous response)
async function retryLastMessage() {
    if (!lastUserMessage) return;

    // Remove the last assistant response and user message from chat history
    if (chatHistory.length >= 2) {
        chatHistory.pop(); // Remove assistant response
        chatHistory.pop(); // Remove user message
        saveChatHistory();
    }

    // Remove the last two message divs from the UI (user + assistant)
    const messagesDiv = document.getElementById('chat-messages');
    const chatMessages = messagesDiv.querySelectorAll('.chat-message');
    if (chatMessages.length >= 2) {
        chatMessages[chatMessages.length - 1].remove(); // Remove assistant
        chatMessages[chatMessages.length - 2].remove(); // Remove user
    }

    // Re-send the last user message
    document.getElementById('chat-input').value = lastUserMessage;
    await sendMessage();
}

// Update retry button visibility
function updateRetryButton() {
    const retryBtn = document.getElementById('retry-btn');
    if (lastUserMessage && chatHistory.length >= 2) {
        retryBtn.classList.remove('hidden');
        retryBtn.classList.add('flex');
    } else {
        retryBtn.classList.add('hidden');
        retryBtn.classList.remove('flex');
    }
}

// Agent verification - deep analysis with code exploration (with SSE streaming)
async function agentVerify() {
    const btn = document.getElementById('agent-verify-btn');
    if (!btn) return;

    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `
        <svg class="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="30 60"></circle>
        </svg>
        Verifying...
    `;

    // Create streaming progress panel
    const progressHtml = `
        <div id="agent-progress-panel" class="bg-gray-800 rounded-lg p-3 border border-purple-500/30">
            <div class="flex items-center gap-2 mb-2">
                <svg class="w-4 h-4 text-purple-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
                <span class="text-sm font-medium text-purple-300">Agent Verification</span>
                <span id="agent-step-counter" class="text-xs text-gray-500 ml-auto">Starting...</span>
            </div>
            <div id="agent-steps-container" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar"></div>
        </div>
    `;
    addMessage('assistant', progressHtml, false);

    const stepsContainer = document.getElementById('agent-steps-container');
    const stepCounter = document.getElementById('agent-step-counter');

    try {
        const modelSelect = document.getElementById('agent-model-select');
        const modelId = modelSelect && modelSelect.value ? modelSelect.value : '';

        const url = `/finding/${findingId}/agent-verify/stream${modelId ? '?model_id=' + modelId : ''}`;
        const eventSource = new EventSource(url);
        let stepCount = 0;

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.type === 'step') {
                stepCount++;
                stepCounter.textContent = `Step ${stepCount}`;

                const step = data.step;
                const stepDiv = document.createElement('div');
                stepDiv.className = 'bg-gray-900/50 rounded p-2 border-l-2 border-purple-500/50 text-xs';

                let stepHtml = `<div class="text-purple-400 font-medium mb-1">Step ${step.step}</div>`;
                if (step.thought) {
                    const thoughtTruncated = step.thought.length > 200 ? step.thought.substring(0, 200) + '...' : step.thought;
                    stepHtml += `<div class="text-gray-400 mb-1">${escapeHtml(thoughtTruncated)}</div>`;
                }
                if (step.tool_name) {
                    stepHtml += `<div class="text-cyan-400 font-mono">→ ${step.tool_name}</div>`;
                    if (step.tool_params) {
                        stepHtml += `<div class="text-gray-500 font-mono text-[10px] truncate">${escapeHtml(step.tool_params)}</div>`;
                    }
                }
                if (step.is_final) {
                    stepHtml += `<div class="text-green-400 mt-1 font-medium">✓ Reached conclusion</div>`;
                }

                stepDiv.innerHTML = stepHtml;
                stepsContainer.appendChild(stepDiv);
                stepsContainer.scrollTop = stepsContainer.scrollHeight;
            } else if (data.type === 'result') {
                eventSource.close();

                // Update progress panel to show completion
                stepCounter.textContent = `Complete (${stepCount} steps)`;
                document.querySelector('#agent-progress-panel svg').classList.remove('animate-pulse');

                if (data.success) {
                    const verdict = data.verified ? '✅ VERIFIED' : '❌ REJECTED';
                    const confidence = data.confidence || 'N/A';

                    let resultMsg = `**Agent Verification Complete**\n\n`;
                    resultMsg += `**Verdict:** ${verdict}\n`;
                    resultMsg += `**Confidence:** ${confidence}%\n\n`;

                    if (data.reasoning) {
                        resultMsg += `**Reasoning:**\n${data.reasoning}\n\n`;
                    }

                    if (data.attack_path && data.verified) {
                        resultMsg += `**Attack Path:**\n${data.attack_path}\n\n`;
                    }

                    if (data.session_id) {
                        resultMsg += `*Session ID: ${data.session_id}*`;
                    }

                    addMessage('assistant', resultMsg);
                } else {
                    addMessage('assistant', `❌ Agent verification failed: ${data.error || 'Unknown error'}`);
                }

                btn.disabled = false;
                btn.innerHTML = originalHTML;
            } else if (data.type === 'error') {
                eventSource.close();
                addMessage('assistant', `❌ Error: ${data.error || 'Unknown error'}`);
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        };

        eventSource.onerror = function(err) {
            eventSource.close();
            stepCounter.textContent = 'Error';
            addMessage('assistant', `❌ Connection error during agent verification`);
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        };

    } catch (err) {
        addMessage('assistant', `❌ Error during agent verification: ${err.message}`);
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
}

// Delete finding with confirmation
async function deleteFinding() {
    if (!confirm('Are you sure you want to delete this finding? This action cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch(`/finding/${findingId}`, {
            method: 'DELETE'
        });

        const data = await response.json();
        if (data.success) {
            window.location.href = '/';
        } else {
            alert('Error deleting finding: ' + (data.error || 'Unknown error'));
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

// Reparse finding using cleanup model
async function reparseFinding() {
    const btn = document.getElementById('reparse-btn');
    const originalHTML = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = `
        <svg class="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="30 60"></circle>
        </svg>
        Reparsing...
    `;

    try {
        const response = await fetch(`/finding/${findingId}/reparse`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.success) {
            // Show success message in chat
            addMessage('assistant', `✓ Successfully reparsed finding!\n\nUpdated fields:\n${Object.entries(data.updates).map(([k, v]) => `• ${k}: ${v}`).join('\n')}\n\nRefreshing page...`);

            // Reload page after short delay to show updated data
            setTimeout(() => window.location.reload(), 2000);
        } else {
            alert('Error reparsing: ' + (data.error || 'Unknown error'));
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        }
    } catch (err) {
        alert('Error: ' + err.message);
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
}

// Configure marked for markdown rendering
if (typeof marked !== 'undefined') {
    marked.setOptions({
        breaks: true,
        gfm: true
    });
}

function renderMarkdownContent() {
    // Find all elements with data-markdown attribute and render
    document.querySelectorAll('.markdown-content[data-markdown]').forEach(function(el) {
        const rawValue = el.getAttribute('data-markdown');
        if (rawValue && rawValue !== 'null') {
            try {
                // Parse the JSON-encoded string
                const markdown = JSON.parse(rawValue);
                if (markdown) {
                    el.innerHTML = marked.parse(markdown);
                }
            } catch (e) {
                console.error('Failed to parse markdown:', e);
                el.textContent = rawValue;
            }
        }
    });

    // Highlight any code blocks
    if (typeof hljs !== 'undefined') {
        document.querySelectorAll('.markdown-content pre code').forEach(function(block) {
            hljs.highlightElement(block);
        });
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', async function() {
    hljs.highlightAll();
    // Render markdown content
    renderMarkdownContent();
    // Hide the floating global chat widget since this page has its own chat panel
    const floatingChat = document.getElementById('quick-chat');
    if (floatingChat) {
        floatingChat.style.display = 'none';
    }

    // Initialize diff view preference BEFORE loading fixes
    // This ensures displayCurrentFix() uses the correct view from the start
    const savedDiffView = localStorage.getItem('diffViewPreference');
    if (savedDiffView) {
        currentDiffView = savedDiffView;
        // Update button styles without re-rendering (fixes not loaded yet)
        const splitView = document.getElementById('split-diff-view');
        const unifiedView = document.getElementById('unified-diff-view');
        const splitBtn = document.getElementById('view-split-btn');
        const unifiedBtn = document.getElementById('view-unified-btn');
        if (savedDiffView === 'unified') {
            splitView.classList.add('hidden');
            unifiedView.classList.remove('hidden');
            splitBtn.className = 'px-2 py-1 text-xs rounded-md transition-colors text-gray-400 hover:text-white';
            unifiedBtn.className = 'px-2 py-1 text-xs rounded-md transition-colors bg-gray-600 text-white';
        }
    }

    // Initialize sync scroll preference
    const savedSyncScroll = localStorage.getItem('syncScrollEnabled');
    if (savedSyncScroll !== null) {
        syncScrollEnabled = savedSyncScroll === 'true';
        document.getElementById('sync-scroll-toggle').checked = syncScrollEnabled;
    }

    // Setup synchronized scrolling
    setupSyncScroll();

    // Load code context with line numbers
    loadCodeContext();
    // Load existing fixes (this will display with the correct view)
    await loadFixes();
    // Load saved chat history for this finding
    loadChatHistory();
});

// Default context lines to show (like GitHub's diff view)
const DEFAULT_CONTEXT_LINES = 30;
let isShowingFullFile = false;
let fullFileData = null;  // Cache full file data
let contextData = null;   // Cache context data

// Load code context with syntax highlighting and vulnerable line marked
// Security note: innerHTML usage below is safe - content is from server filesystem files (not user input),
// line numbers are integers, and code is processed through highlight.js which generates sanitized HTML
async function loadCodeContext() {
    try {
        // First load context view (30 lines around vulnerable line)
        const contextResponse = await fetch(`/finding/${findingId}/code-context?context_lines=${DEFAULT_CONTEXT_LINES}`);
        contextData = await contextResponse.json();

        // Also prefetch full file in background for quick toggling
        fetch(`/finding/${findingId}/code-context?full_file=true`)
            .then(r => r.json())
            .then(data => {
                fullFileData = data;
                // Store original file content globally for diff expansion
                if (data.lines) {
                    originalFileContent = data.lines.map(line => ({
                        number: line.number,
                        content: line.content,
                        isVulnerable: line.is_vulnerable
                    }));
                }
            })
            .catch(e => console.warn('Failed to prefetch full file:', e));

        renderCodeView(contextData, false);
    } catch (err) {
        console.error('Failed to load code context:', err);
        const container = document.getElementById('vulnerable-code-container');
        container.textContent = `Error loading file: ${err.message}`;
    }
}

// Toggle between context view and full file view
function toggleFullFile() {
    isShowingFullFile = !isShowingFullFile;

    const btnText = document.getElementById('toggle-full-file-text');
    if (isShowingFullFile) {
        if (fullFileData) {
            renderCodeView(fullFileData, true);
            btnText.textContent = 'Context only';
        } else {
            // Full file not loaded yet, fetch it
            fetch(`/finding/${findingId}/code-context?full_file=true`)
                .then(r => r.json())
                .then(data => {
                    fullFileData = data;
                    renderCodeView(fullFileData, true);
                    btnText.textContent = 'Context only';
                });
        }
    } else {
        renderCodeView(contextData, false);
        btnText.textContent = 'Full file';
    }
}

// Render code view (shared by context and full file modes)
// Security note: innerHTML is safe here - data.lines comes from server filesystem,
// line.number is an integer, and highlightedLine is sanitized by highlight.js
function renderCodeView(data, isFullFile) {
    const container = document.getElementById('vulnerable-code-container');

    if (!data || data.error || !data.lines || data.lines.length === 0) {
        // Fallback to snippet (safe: server-side escaped via Jinja |e filter)
        container.innerHTML = `<pre class="p-3"><code class="language-{{ 'python' if finding.file_path.endswith('.py') else 'cpp' if finding.file_path.endswith('.cpp') else 'c' }}">{{ finding.snippet | strip_code | e }}</code></pre>`;
        hljs.highlightAll();
        return;
    }

    // Determine language for syntax highlighting
    const ext = filePath.split('.').pop().toLowerCase();
    const langMap = {
        'py': 'python', 'c': 'c', 'cpp': 'cpp', 'cc': 'cpp', 'h': 'c', 'hpp': 'cpp',
        'js': 'javascript', 'ts': 'typescript', 'java': 'java', 'rs': 'rust', 'go': 'go'
    };
    const language = langMap[ext] || 'plaintext';

    // Build the code content for highlighting
    const codeContent = data.lines.map(line => line.content).join('\n');

    // Create highlighted code using highlight.js (generates sanitized HTML)
    let highlightedCode;
    try {
        highlightedCode = hljs.highlight(codeContent, { language: language, ignoreIllegals: true }).value;
    } catch (e) {
        highlightedCode = escapeHtml(codeContent);
    }

    // Split highlighted code back into lines
    const highlightedLines = highlightedCode.split('\n');

    // Build table with line numbers and syntax highlighting
    let html = '<table class="w-full border-collapse"><tbody>';

    // Add expand-up indicator if showing context and there's more above
    if (!isFullFile && data.lines.length > 0 && data.lines[0].number > 1) {
        const linesAbove = data.lines[0].number - 1;
        html += `<tr class="diff-expand-row">
            <td colspan="2" class="text-center py-1">
                <button onclick="toggleFullFile()" class="diff-expand-btn">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                    </svg>
                    Expand up (${linesAbove} more lines)
                </button>
            </td>
        </tr>`;
    }

    for (let i = 0; i < data.lines.length; i++) {
        const line = data.lines[i];
        const highlightedLine = highlightedLines[i] || '';

        // Vulnerable line styling
        const isVuln = line.is_vulnerable;
        const rowId = isVuln ? 'vulnerable-line' : '';
        const bgClass = isVuln ? 'bg-red-900/50 border-l-4 border-red-500' : 'hover:bg-gray-800/30';
        const lineNumClass = isVuln ? 'text-red-400 font-bold bg-red-900/30' : 'text-gray-600';

        // line.number is integer from server, highlightedLine is sanitized by highlight.js
        html += `<tr id="${rowId}" class="${bgClass}">
            <td class="px-2 py-0 text-right select-none ${lineNumClass} border-r border-gray-700 sticky left-0 bg-gray-900" style="min-width: 50px;">${line.number}</td>
            <td class="px-3 py-0 whitespace-pre">${highlightedLine}</td>
        </tr>`;
    }

    // Add expand-down indicator if showing context and there's more below
    if (!isFullFile && data.lines.length > 0 && data.total_lines) {
        const lastLineNum = data.lines[data.lines.length - 1].number;
        if (lastLineNum < data.total_lines) {
            const linesBelow = data.total_lines - lastLineNum;
            html += `<tr class="diff-expand-row">
                <td colspan="2" class="text-center py-1">
                    <button onclick="toggleFullFile()" class="diff-expand-btn">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                        Expand down (${linesBelow} more lines)
                    </button>
                </td>
            </tr>`;
        }
    }

    html += '</tbody></table>';
    // Safe: html is built from server filesystem content, integers, and highlight.js sanitized output
    container.innerHTML = html;

    // Update header info
    const infoSpan = document.getElementById('code-context-info');
    if (infoSpan && data.total_lines) {
        if (isFullFile) {
            infoSpan.textContent = `${data.total_lines} lines | Line ${data.vulnerable_line}`;
        } else {
            const showing = data.lines.length;
            infoSpan.textContent = `${showing} of ${data.total_lines} lines | Line ${data.vulnerable_line}`;
        }
    }

    // Update button text
    const btnText = document.getElementById('toggle-full-file-text');
    if (btnText) {
        btnText.textContent = isFullFile ? 'Context only' : 'Full file';
    }

    // Scroll to vulnerable line after a short delay
    setTimeout(() => {
        const vulnRow = document.getElementById('vulnerable-line');
        if (vulnRow) {
            vulnRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }, 100);
}

// Load all existing fixes for this finding (both DB fixes and diff files)
async function loadFixes() {
    try {
        // Load database fixes
        const response = await fetch(`/finding/${findingId}/fixes`);
        const data = await response.json();
        allFixes = data.fixes || [];

        // Also load diff files
        const diffResponse = await fetch(`/finding/${findingId}/diff-files`);
        const diffData = await diffResponse.json();

        if (diffData.diff_files && diffData.diff_files.length > 0) {
            // Add diff files to allFixes with a special type
            for (const diffFile of diffData.diff_files) {
                allFixes.push({
                    id: `diff_${diffFile.model}`,
                    fix_type: 'diff',
                    model_name: diffFile.model,
                    code: null,  // Will be loaded on demand
                    diff_path: diffFile.path,
                    diff_filename: diffFile.filename,
                    created_at: new Date(diffFile.created * 1000).toISOString()
                });
            }
        }

        if (allFixes.length > 0) {
            currentFixIndex = 0;
            updateFixNav();
            // Display the first fix immediately
            // Note: Must await to ensure diff content is loaded before rendering
            await displayCurrentFix();
        }
    } catch (err) {
        console.error('Failed to load fixes:', err);
    }
}

// Load diff file content for display
async function loadDiffContent(model) {
    try {
        const response = await fetch(`/finding/${findingId}/diff-file/${encodeURIComponent(model)}`);
        const data = await response.json();
        if (data.error) {
            return null;
        }
        return data.content;
    } catch (err) {
        console.error('Failed to load diff content:', err);
        return null;
    }
}

// Update fix navigation UI
function updateFixNav() {
    const nav = document.getElementById('fix-nav');
    const counter = document.getElementById('fix-counter');
    const badge = document.getElementById('fix-type-badge');

    if (allFixes.length > 0) {
        nav.classList.remove('hidden');
        nav.classList.add('flex');
        counter.textContent = `${currentFixIndex + 1}/${allFixes.length}`;

        const currentFix = allFixes[currentFixIndex];
        if (currentFix.fix_type === 'diff') {
            badge.textContent = 'Diff';
            badge.className = 'text-xs px-1.5 py-0.5 rounded bg-cyan-600/50 text-cyan-300';
        } else if (currentFix.fix_type === 'agent') {
            badge.textContent = 'Agent';
            badge.className = 'text-xs px-1.5 py-0.5 rounded bg-purple-600/50 text-purple-300';
        } else {
            badge.textContent = 'Quick';
            badge.className = 'text-xs px-1.5 py-0.5 rounded bg-green-600/50 text-green-300';
        }
    } else {
        nav.classList.add('hidden');
    }
}

// Navigate to previous fix
function prevFix() {
    if (allFixes.length > 0) {
        currentFixIndex = (currentFixIndex - 1 + allFixes.length) % allFixes.length;
        displayCurrentFix();
    }
}

// Navigate to next fix
function nextFix() {
    if (allFixes.length > 0) {
        currentFixIndex = (currentFixIndex + 1) % allFixes.length;
        displayCurrentFix();
    }
}

// Display the current fix
async function displayCurrentFix() {
    if (allFixes.length === 0) return;

    const fix = allFixes[currentFixIndex];
    updateFixNav();

    const container = document.getElementById('fixed-code-container');
    const loading = document.getElementById('fix-loading');
    const placeholder = document.getElementById('no-fix-placeholder');

    if (placeholder) placeholder.remove();

    // Handle diff file type - parse and display properly
    if (fix.fix_type === 'diff') {
        // Load diff content if not already loaded
        if (!fix.code) {
            fix.code = await loadDiffContent(fix.model_name);
        }

        if (!fix.code) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'p-4 text-center text-gray-500';
            errorDiv.textContent = 'Error loading diff content';
            container.textContent = '';
            container.appendChild(errorDiv);
            return;
        }

        // For split view: parse diff and show before/after side by side
        if (currentDiffView === 'split') {
            displayDiffInSplitView(fix.code);
        } else {
            // For unified view: show the raw diff with colors
            displayDiffInUnifiedView(fix.code);
        }
        return;
    }

    // Regular fix display
    let codeContainer = document.getElementById('fixed-code');
    if (!codeContainer) {
        const pre = document.createElement('pre');
        pre.className = 'p-3 text-xs overflow-x-auto bg-gray-900 h-full';
        const code = document.createElement('code');
        code.id = 'fixed-code';
        code.className = 'language-{{ "python" if finding.file_path.endswith(".py") else "cpp" if finding.file_path.endswith(".cpp") else "c" }}';
        pre.appendChild(code);
        container.insertBefore(pre, loading);
        codeContainer = code;
    } else {
        // Reset language class for regular code
        codeContainer.className = 'language-{{ "python" if finding.file_path.endswith(".py") else "cpp" if finding.file_path.endswith(".cpp") else "c" }}';
    }

    codeContainer.textContent = fix.code;
    hljs.highlightElement(codeContainer);

    // Update unified diff if in unified view
    if (currentDiffView === 'unified') {
        generateUnifiedDiff();
    }
}

// Parse unified diff into structured hunks
function parseDiff(diffContent) {
    const lines = diffContent.split('\n');
    const hunks = [];
    let currentHunk = null;
    let oldFile = '', newFile = '';
    let addCount = 0, delCount = 0;

    for (const line of lines) {
        if (line.startsWith('---')) {
            oldFile = line.substring(4).trim();
        } else if (line.startsWith('+++')) {
            newFile = line.substring(4).trim();
        } else if (line.startsWith('@@')) {
            // Parse hunk header: @@ -oldStart,oldCount +newStart,newCount @@
            const match = line.match(/@@ -(\d+)(?:,(\d+))? \+(\d+)(?:,(\d+))? @@(.*)?/);
            if (match) {
                currentHunk = {
                    oldStart: parseInt(match[1]),
                    oldCount: parseInt(match[2] || 1),
                    newStart: parseInt(match[3]),
                    newCount: parseInt(match[4] || 1),
                    context: match[5] || '',
                    lines: []
                };
                hunks.push(currentHunk);
            }
        } else if (currentHunk) {
            if (line.startsWith('+')) {
                currentHunk.lines.push({ type: 'add', content: line.substring(1) });
                addCount++;
            } else if (line.startsWith('-')) {
                currentHunk.lines.push({ type: 'del', content: line.substring(1) });
                delCount++;
            } else if (line.startsWith(' ') || line === '') {
                currentHunk.lines.push({ type: 'context', content: line.substring(1) || '' });
            }
        }
    }

    return { oldFile, newFile, hunks, addCount, delCount };
}

// Display GitHub/GitLab-style unified diff view
function displayDiffInUnifiedView(diffContent) {
    const container = document.getElementById('unified-diff-container');
    if (!container) return;

    container.innerHTML = '';  // Clear
    const parsed = parseDiff(diffContent);
    currentParsedDiff = parsed;

    // Toolbar with controls
    const toolbar = document.createElement('div');
    toolbar.className = 'diff-toolbar';
    toolbar.innerHTML = `
        <div class="flex items-center gap-3">
            <span class="diff-file-path">${escapeHtml(parsed.newFile || filePath)}</span>
            <span class="diff-stats">
                <span class="diff-stats-add">+${parsed.addCount}</span>
                <span class="diff-stats-del ml-2">-${parsed.delCount}</span>
            </span>
        </div>
        <div class="flex items-center gap-2">
            <label class="flex items-center gap-1 text-xs text-gray-400">
                Context:
                <select class="diff-context-select" onchange="setDiffContextLines(this.value)">
                    <option value="3" ${diffContextLines === 3 ? 'selected' : ''}>3 lines</option>
                    <option value="5" ${diffContextLines === 5 ? 'selected' : ''}>5 lines</option>
                    <option value="10" ${diffContextLines === 10 ? 'selected' : ''}>10 lines</option>
                    <option value="25" ${diffContextLines === 25 ? 'selected' : ''}>25 lines</option>
                </select>
            </label>
            <button class="diff-toolbar-btn ${showFullFile ? 'active' : ''}" onclick="toggleFullFile()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                </svg>
                ${showFullFile ? 'Show changes only' : 'Load entire file'}
            </button>
        </div>
    `;
    container.appendChild(toolbar);

    // Create table for diff
    const table = document.createElement('table');
    table.className = 'diff-table';
    const tbody = document.createElement('tbody');

    if (showFullFile && originalFileContent.length > 0) {
        // Full file mode - show entire file with changes highlighted
        renderFullFileUnified(tbody, parsed);
    } else {
        // Normal mode - show only hunks with expand buttons
        renderHunksUnified(tbody, parsed);
    }

    table.appendChild(tbody);
    container.appendChild(table);
}

// Render hunks with expand buttons for unified view
function renderHunksUnified(tbody, parsed) {
    let lastEndLine = 0;

    for (let hunkIdx = 0; hunkIdx < parsed.hunks.length; hunkIdx++) {
        const hunk = parsed.hunks[hunkIdx];
        const hunkStartLine = hunk.oldStart;

        // Add expand button if there's a gap
        if (hunkStartLine > lastEndLine + 1 && originalFileContent.length > 0) {
            const gapStart = lastEndLine + 1;
            const gapEnd = hunkStartLine - 1;
            addExpandRowUnified(tbody, gapStart, gapEnd, hunkIdx);
        }

        // Hunk header row
        const hunkRow = document.createElement('tr');
        hunkRow.className = 'diff-hunk-header';
        hunkRow.innerHTML = `
            <td class="diff-line-num"></td>
            <td class="diff-line-num"></td>
            <td>@@ -${hunk.oldStart},${hunk.oldCount} +${hunk.newStart},${hunk.newCount} @@${hunk.context ? ' ' + escapeHtml(hunk.context) : ''}</td>
        `;
        tbody.appendChild(hunkRow);

        let oldLine = hunk.oldStart;
        let newLine = hunk.newStart;

        for (const line of hunk.lines) {
            const row = document.createElement('tr');
            let oldNum = '', newNum = '', rowClass = 'diff-context';

            if (line.type === 'del') {
                oldNum = oldLine++;
                rowClass = 'diff-del';
            } else if (line.type === 'add') {
                newNum = newLine++;
                rowClass = 'diff-add';
            } else {
                oldNum = oldLine++;
                newNum = newLine++;
            }

            row.className = rowClass;
            row.innerHTML = `
                <td class="diff-line-num">${oldNum}</td>
                <td class="diff-line-num">${newNum}</td>
                <td class="diff-line-content"><pre>${escapeHtml(line.content)}</pre></td>
            `;
            tbody.appendChild(row);
        }

        lastEndLine = hunk.oldStart + hunk.oldCount - 1;
    }

    // Add expand button for remaining lines after last hunk
    if (originalFileContent.length > lastEndLine) {
        addExpandRowUnified(tbody, lastEndLine + 1, originalFileContent.length, -1);
    }
}

// Add expandable row between hunks
function addExpandRowUnified(tbody, startLine, endLine, hunkIdx) {
    const lineCount = endLine - startLine + 1;
    if (lineCount <= 0) return;

    const row = document.createElement('tr');
    row.className = 'diff-expand-row';
    row.innerHTML = `
        <td class="diff-line-num" colspan="2"></td>
        <td>
            <button class="diff-expand-btn" onclick="expandContext(${startLine}, ${endLine}, 'up', ${hunkIdx})">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                Expand up
            </button>
            <button class="diff-expand-btn ml-2" onclick="expandContext(${startLine}, ${endLine}, 'all', ${hunkIdx})">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                Show ${lineCount} hidden lines
            </button>
            <button class="diff-expand-btn ml-2" onclick="expandContext(${startLine}, ${endLine}, 'down', ${hunkIdx})">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                Expand down
            </button>
        </td>
    `;
    tbody.appendChild(row);
}

// Render full file with changes highlighted for unified view
function renderFullFileUnified(tbody, parsed) {
    // Build a map of line changes from the diff
    const lineChanges = new Map(); // lineNum -> {type: 'del'|'add'|'context', newLineNum?}

    let newLineOffset = 0;
    for (const hunk of parsed.hunks) {
        let oldLine = hunk.oldStart;
        let newLine = hunk.newStart;

        for (const line of hunk.lines) {
            if (line.type === 'del') {
                lineChanges.set(oldLine, { type: 'del', content: line.content });
                oldLine++;
            } else if (line.type === 'add') {
                // Track additions to insert after deletions
                if (!lineChanges.has(`add_${newLine}`)) {
                    lineChanges.set(`add_${newLine}`, { type: 'add', content: line.content, newLineNum: newLine });
                }
                newLine++;
                newLineOffset++;
            } else {
                oldLine++;
                newLine++;
            }
        }
    }

    // Render all lines from original file, interleaving additions
    let newLineNum = 1;
    for (let i = 0; i < originalFileContent.length; i++) {
        const fileLine = originalFileContent[i];
        const lineNum = fileLine.number;
        const change = lineChanges.get(lineNum);

        if (change && change.type === 'del') {
            // This line is deleted
            const row = document.createElement('tr');
            row.className = 'diff-del';
            row.innerHTML = `
                <td class="diff-line-num">${lineNum}</td>
                <td class="diff-line-num"></td>
                <td class="diff-line-content"><pre>${escapeHtml(change.content)}</pre></td>
            `;
            tbody.appendChild(row);

            // Check for additions that follow this deletion
            const addKey = `add_${newLineNum}`;
            while (lineChanges.has(addKey)) {
                const addChange = lineChanges.get(addKey);
                const addRow = document.createElement('tr');
                addRow.className = 'diff-add';
                addRow.innerHTML = `
                    <td class="diff-line-num"></td>
                    <td class="diff-line-num">${addChange.newLineNum}</td>
                    <td class="diff-line-content"><pre>${escapeHtml(addChange.content)}</pre></td>
                `;
                tbody.appendChild(addRow);
                lineChanges.delete(addKey);
                newLineNum++;
            }
        } else {
            // Context line (unchanged)
            const row = document.createElement('tr');
            row.className = 'diff-context';
            row.innerHTML = `
                <td class="diff-line-num">${lineNum}</td>
                <td class="diff-line-num">${newLineNum}</td>
                <td class="diff-line-content"><pre>${escapeHtml(fileLine.content)}</pre></td>
            `;
            tbody.appendChild(row);
            newLineNum++;
        }
    }
}

// Toggle showing full file vs just changes
function toggleFullFile() {
    showFullFile = !showFullFile;
    refreshDiffDisplay();
}

// Set number of context lines
function setDiffContextLines(value) {
    diffContextLines = parseInt(value);
    refreshDiffDisplay();
}

// Expand context lines
function expandContext(startLine, endLine, direction, hunkIdx) {
    // For now, toggle to full file mode (simpler implementation)
    showFullFile = true;
    refreshDiffDisplay();
}

// Refresh the current diff display
function refreshDiffDisplay() {
    const currentFix = allFixes[currentFixIndex];
    if (currentFix && currentFix.fix_type === 'diff' && currentFix.code) {
        if (currentDiffView === 'unified') {
            displayDiffInUnifiedView(currentFix.code);
        } else {
            displayDiffInSplitView(currentFix.code);
        }
    }
}

// Display GitHub/GitLab-style split diff view
function displayDiffInSplitView(diffContent) {
    const fixedContainer = document.getElementById('fixed-code-container');
    const vulnContainer = document.getElementById('vulnerable-code-container');
    if (!fixedContainer) return;

    const parsed = parseDiff(diffContent);
    currentParsedDiff = parsed;

    // Clear both containers
    vulnContainer.innerHTML = '';
    fixedContainer.innerHTML = '';

    // Add toolbar to left pane header area (we'll add a shared toolbar above both)
    const splitView = document.getElementById('split-diff-view');
    let toolbar = splitView.querySelector('.diff-toolbar');
    if (!toolbar) {
        toolbar = document.createElement('div');
        toolbar.className = 'diff-toolbar col-span-2';
        toolbar.innerHTML = `
            <div class="flex items-center gap-3">
                <span class="diff-file-path">${escapeHtml(parsed.newFile || filePath)}</span>
                <span class="diff-stats">
                    <span class="diff-stats-add">+${parsed.addCount}</span>
                    <span class="diff-stats-del ml-2">-${parsed.delCount}</span>
                </span>
            </div>
            <div class="flex items-center gap-2">
                <button class="diff-toolbar-btn ${showFullFile ? 'active' : ''}" onclick="toggleFullFile()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                    </svg>
                    ${showFullFile ? 'Show changes only' : 'Load entire file'}
                </button>
            </div>
        `;
        splitView.insertBefore(toolbar, splitView.firstChild);
    } else {
        // Update existing toolbar
        toolbar.innerHTML = `
            <div class="flex items-center gap-3">
                <span class="diff-file-path">${escapeHtml(parsed.newFile || filePath)}</span>
                <span class="diff-stats">
                    <span class="diff-stats-add">+${parsed.addCount}</span>
                    <span class="diff-stats-del ml-2">-${parsed.delCount}</span>
                </span>
            </div>
            <div class="flex items-center gap-2">
                <button class="diff-toolbar-btn ${showFullFile ? 'active' : ''}" onclick="toggleFullFile()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                    </svg>
                    ${showFullFile ? 'Show changes only' : 'Load entire file'}
                </button>
            </div>
        `;
    }

    // Build aligned left/right data
    let leftLines, rightLines;

    if (showFullFile && originalFileContent.length > 0) {
        // Full file mode
        const result = buildFullFileSplitData(parsed);
        leftLines = result.leftLines;
        rightLines = result.rightLines;
    } else {
        // Hunks only mode
        const result = buildHunksSplitData(parsed);
        leftLines = result.leftLines;
        rightLines = result.rightLines;
    }

    // Render left pane
    const leftWrapper = document.createElement('div');
    leftWrapper.className = 'overflow-auto';
    leftWrapper.style.maxHeight = '500px';
    const leftTable = createDiffTable(leftLines, 'left');
    leftWrapper.appendChild(leftTable);
    vulnContainer.appendChild(leftWrapper);

    // Render right pane
    const rightWrapper = document.createElement('div');
    rightWrapper.className = 'overflow-auto';
    rightWrapper.style.maxHeight = '500px';
    const rightTable = createDiffTable(rightLines, 'right');
    rightWrapper.appendChild(rightTable);
    fixedContainer.appendChild(rightWrapper);

    // Add loading div back (hidden)
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'fix-loading';
    loadingDiv.className = 'hidden absolute inset-0 bg-gray-900/80 flex items-center justify-center';
    fixedContainer.appendChild(loadingDiv);

    // Setup synchronized scrolling for split view
    setupSplitDiffScroll(leftWrapper, rightWrapper);
}

// Build split view data from hunks only
function buildHunksSplitData(parsed) {
    const leftLines = [];
    const rightLines = [];

    for (const hunk of parsed.hunks) {
        leftLines.push({ type: 'hunk', text: `@@ -${hunk.oldStart},${hunk.oldCount} +${hunk.newStart},${hunk.newCount} @@${hunk.context || ''}` });
        rightLines.push({ type: 'hunk', text: `@@ -${hunk.oldStart},${hunk.oldCount} +${hunk.newStart},${hunk.newCount} @@${hunk.context || ''}` });

        let oldLineNum = hunk.oldStart;
        let newLineNum = hunk.newStart;
        let i = 0;

        while (i < hunk.lines.length) {
            const line = hunk.lines[i];

            if (line.type === 'context') {
                leftLines.push({ type: 'context', num: oldLineNum++, content: line.content });
                rightLines.push({ type: 'context', num: newLineNum++, content: line.content });
                i++;
            } else if (line.type === 'del') {
                const dels = [], adds = [];
                while (i < hunk.lines.length && hunk.lines[i].type === 'del') {
                    dels.push({ num: oldLineNum++, content: hunk.lines[i].content });
                    i++;
                }
                while (i < hunk.lines.length && hunk.lines[i].type === 'add') {
                    adds.push({ num: newLineNum++, content: hunk.lines[i].content });
                    i++;
                }
                const maxLen = Math.max(dels.length, adds.length);
                for (let j = 0; j < maxLen; j++) {
                    leftLines.push(j < dels.length ? { type: 'del', num: dels[j].num, content: dels[j].content } : { type: 'empty' });
                    rightLines.push(j < adds.length ? { type: 'add', num: adds[j].num, content: adds[j].content } : { type: 'empty' });
                }
            } else if (line.type === 'add') {
                leftLines.push({ type: 'empty' });
                rightLines.push({ type: 'add', num: newLineNum++, content: line.content });
                i++;
            }
        }
    }

    return { leftLines, rightLines };
}

// Build split view data for full file
function buildFullFileSplitData(parsed) {
    const leftLines = [];
    const rightLines = [];

    // Build maps of changes
    const deletions = new Map(); // oldLineNum -> content
    const additions = []; // {afterOldLine, newLineNum, content}

    for (const hunk of parsed.hunks) {
        let oldLine = hunk.oldStart;
        let newLine = hunk.newStart;
        let lastOldLine = hunk.oldStart - 1;

        for (const line of hunk.lines) {
            if (line.type === 'del') {
                deletions.set(oldLine, line.content);
                lastOldLine = oldLine;
                oldLine++;
            } else if (line.type === 'add') {
                additions.push({ afterOldLine: lastOldLine, newLineNum: newLine, content: line.content });
                newLine++;
            } else {
                lastOldLine = oldLine;
                oldLine++;
                newLine++;
            }
        }
    }

    // Render full file with interleaved additions
    let newLineNum = 1;
    let addIdx = 0;

    for (let i = 0; i < originalFileContent.length; i++) {
        const fileLine = originalFileContent[i];
        const lineNum = fileLine.number;

        // Check for additions that should appear before this line
        while (addIdx < additions.length && additions[addIdx].afterOldLine < lineNum) {
            leftLines.push({ type: 'empty' });
            rightLines.push({ type: 'add', num: additions[addIdx].newLineNum, content: additions[addIdx].content });
            addIdx++;
        }

        if (deletions.has(lineNum)) {
            // This line is deleted
            leftLines.push({ type: 'del', num: lineNum, content: deletions.get(lineNum) });
            rightLines.push({ type: 'empty' });

            // Check for additions immediately after this deletion
            while (addIdx < additions.length && additions[addIdx].afterOldLine === lineNum) {
                leftLines.push({ type: 'empty' });
                rightLines.push({ type: 'add', num: additions[addIdx].newLineNum, content: additions[addIdx].content });
                addIdx++;
            }
        } else {
            // Context line (unchanged)
            leftLines.push({ type: 'context', num: lineNum, content: fileLine.content });
            rightLines.push({ type: 'context', num: newLineNum, content: fileLine.content });
            newLineNum++;

            // Check for additions after this context line
            while (addIdx < additions.length && additions[addIdx].afterOldLine === lineNum) {
                leftLines.push({ type: 'empty' });
                rightLines.push({ type: 'add', num: additions[addIdx].newLineNum, content: additions[addIdx].content });
                addIdx++;
            }
        }
    }

    // Any remaining additions
    while (addIdx < additions.length) {
        leftLines.push({ type: 'empty' });
        rightLines.push({ type: 'add', num: additions[addIdx].newLineNum, content: additions[addIdx].content });
        addIdx++;
    }

    return { leftLines, rightLines };
}

// Create diff table from line data
function createDiffTable(lines, side) {
    const table = document.createElement('table');
    table.className = 'diff-table';
    const tbody = document.createElement('tbody');

    for (const line of lines) {
        const row = document.createElement('tr');
        if (line.type === 'hunk') {
            row.className = 'diff-hunk-header';
            row.innerHTML = `<td class="diff-line-num"></td><td class="diff-line-content">${escapeHtml(line.text)}</td>`;
        } else if (line.type === 'empty') {
            row.className = 'diff-empty';
            row.innerHTML = `<td class="diff-line-num"></td><td class="diff-line-content"><pre> </pre></td>`;
        } else if (line.type === 'del') {
            row.className = 'diff-del';
            row.innerHTML = `<td class="diff-line-num">${line.num}</td><td class="diff-line-content"><pre>${escapeHtml(line.content)}</pre></td>`;
        } else if (line.type === 'add') {
            row.className = 'diff-add';
            row.innerHTML = `<td class="diff-line-num">${line.num}</td><td class="diff-line-content"><pre>${escapeHtml(line.content)}</pre></td>`;
        } else {
            row.className = 'diff-context';
            row.innerHTML = `<td class="diff-line-num">${line.num}</td><td class="diff-line-content"><pre>${escapeHtml(line.content)}</pre></td>`;
        }
        tbody.appendChild(row);
    }

    table.appendChild(tbody);
    return table;
}

// Sync scroll between split diff panes
function setupSplitDiffScroll(leftPane, rightPane) {
    let isSyncing = false;

    function sync(source, target) {
        if (!syncScrollEnabled || isSyncing) return;
        isSyncing = true;
        target.scrollTop = source.scrollTop;
        target.scrollLeft = source.scrollLeft;
        setTimeout(() => { isSyncing = false; }, 10);
    }

    leftPane.addEventListener('scroll', () => sync(leftPane, rightPane));
    rightPane.addEventListener('scroll', () => sync(rightPane, leftPane));
}

// Quick Fix function (single-shot with file context)
async function generateQuickFix() {
    await generateFixWithEndpoint('/generate-fix', 'quick-fix-btn', 'Generating quick fix...');
}

// Agent Fix function with SSE streaming (agentic approach with tool use)
// Note: All dynamic content is sanitized via escapeHtml() before insertion
async function generateAgentFix() {
    const quickBtn = document.getElementById('quick-fix-btn');
    const agentBtn = document.getElementById('agent-fix-btn');
    const modelSelect = document.getElementById('fix-model-select');
    const modelId = modelSelect.value;

    if (!agentBtn) return;

    const originalHTML = agentBtn.innerHTML;
    agentBtn.disabled = true;
    quickBtn.disabled = true;
    agentBtn.textContent = 'Starting...';

    // Create streaming progress panel in chat (static HTML structure)
    const progressHtml = `
        <div id="fix-progress-panel" class="bg-gray-800 rounded-lg p-3 border border-green-500/30">
            <div class="flex items-center gap-2 mb-2">
                <svg class="w-4 h-4 text-green-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
                <span class="text-sm font-medium text-green-300">Agent Fix Generation</span>
                <span id="fix-step-counter" class="text-xs text-gray-500 ml-auto">Starting...</span>
            </div>
            <div id="fix-steps-container" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar"></div>
        </div>
    `;
    addMessage('assistant', progressHtml, false);

    const stepsContainer = document.getElementById('fix-steps-container');
    const stepCounter = document.getElementById('fix-step-counter');

    try {
        const url = `/finding/${findingId}/agent-fix/stream${modelId ? '?model_id=' + modelId : ''}`;
        const eventSource = new EventSource(url);
        let stepCount = 0;

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.type === 'step') {
                stepCount++;
                stepCounter.textContent = `Step ${stepCount}`;
                agentBtn.textContent = `Step ${stepCount}...`;

                const step = data.step;
                const stepDiv = document.createElement('div');
                stepDiv.className = 'bg-gray-900/50 rounded p-2 border-l-2 border-green-500/50 text-xs';

                // Build step content using DOM methods for safety
                const headerDiv = document.createElement('div');
                headerDiv.className = 'text-green-400 font-medium mb-1';
                headerDiv.textContent = `Step ${step.step} - ${step.type}`;
                stepDiv.appendChild(headerDiv);

                if (step.thought) {
                    const thoughtDiv = document.createElement('div');
                    thoughtDiv.className = 'text-gray-400 mb-1';
                    thoughtDiv.textContent = step.thought.length > 200 ? step.thought.substring(0, 200) + '...' : step.thought;
                    stepDiv.appendChild(thoughtDiv);
                }
                if (step.tool_name) {
                    const toolDiv = document.createElement('div');
                    toolDiv.className = 'text-cyan-400 font-mono';
                    toolDiv.textContent = `→ ${step.tool_name}`;
                    stepDiv.appendChild(toolDiv);

                    if (step.tool_args) {
                        const argsDiv = document.createElement('div');
                        argsDiv.className = 'text-gray-500 font-mono text-[10px] truncate';
                        argsDiv.textContent = step.tool_args;
                        stepDiv.appendChild(argsDiv);
                    }
                }
                if (step.result_preview) {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'text-gray-500 text-[10px] truncate mt-1';
                    resultDiv.textContent = `Result: ${step.result_preview}`;
                    stepDiv.appendChild(resultDiv);
                }
                if (step.is_final) {
                    const finalDiv = document.createElement('div');
                    finalDiv.className = 'text-green-400 mt-1 font-medium';
                    finalDiv.textContent = '✓ Generated fix';
                    stepDiv.appendChild(finalDiv);
                }

                stepsContainer.appendChild(stepDiv);
                stepsContainer.scrollTop = stepsContainer.scrollHeight;

            } else if (data.type === 'result') {
                eventSource.close();

                // Update progress panel to show completion
                stepCounter.textContent = `Complete (${stepCount} steps)`;
                const pulsingIcon = document.querySelector('#fix-progress-panel svg');
                if (pulsingIcon) pulsingIcon.classList.remove('animate-pulse');

                if (data.success) {
                    // Reload fixes to include the new one
                    loadFixes().then(() => {
                        currentFixIndex = 0;
                        displayCurrentFix();
                    });

                    // Show success message with duration
                    const durationSec = data.duration_ms ? (data.duration_ms / 1000).toFixed(1) : '?';
                    let resultMsg = `**Agent Fix Generated Successfully**\n\n`;
                    resultMsg += `**Duration:** ${durationSec}s\n`;
                    resultMsg += `**Iterations:** ${data.iterations || stepCount}\n\n`;

                    if (data.reasoning && data.reasoning.length > 0) {
                        resultMsg += `**Steps:**\n${data.reasoning.map((r, i) => `${i+1}. ${r}`).join('\n')}\n\n`;
                    }

                    if (data.session_id) {
                        resultMsg += `*Session ID: ${data.session_id}*`;
                    }

                    addMessage('assistant', resultMsg);
                } else {
                    addMessage('assistant', `Agent fix generation failed: ${data.error || 'No fix generated'}`);
                }

                agentBtn.disabled = false;
                quickBtn.disabled = false;
                agentBtn.innerHTML = originalHTML;

            } else if (data.type === 'error') {
                eventSource.close();
                stepCounter.textContent = 'Error';
                addMessage('assistant', `Error: ${data.error || 'Unknown error'}`);
                agentBtn.disabled = false;
                quickBtn.disabled = false;
                agentBtn.innerHTML = originalHTML;
            }
        };

        eventSource.onerror = function(err) {
            eventSource.close();
            stepCounter.textContent = 'Error';
            addMessage('assistant', `Connection error during agent fix generation`);
            agentBtn.disabled = false;
            quickBtn.disabled = false;
            agentBtn.innerHTML = originalHTML;
        };

    } catch (err) {
        addMessage('assistant', `Error during agent fix: ${err.message}`);
        agentBtn.disabled = false;
        quickBtn.disabled = false;
        agentBtn.innerHTML = originalHTML;
    }
}

// Shared fix generation logic
async function generateFixWithEndpoint(endpoint, buttonId, loadingText) {
    const btn = document.getElementById(buttonId);
    const quickBtn = document.getElementById('quick-fix-btn');
    const agentBtn = document.getElementById('agent-fix-btn');
    const loading = document.getElementById('fix-loading');
    const loadingTextEl = document.getElementById('fix-loading-text');
    const container = document.getElementById('fixed-code-container');
    const placeholder = document.getElementById('no-fix-placeholder');
    const modelSelect = document.getElementById('fix-model-select');
    const modelId = modelSelect.value;

    // Disable both buttons
    quickBtn.disabled = true;
    agentBtn.disabled = true;
    loading.classList.remove('hidden');

    // Update loading text
    if (loadingTextEl) loadingTextEl.textContent = loadingText;

    try {
        const response = await fetch(`/finding/${findingId}${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ model_id: modelId })
        });

        const data = await response.json();
        loading.classList.add('hidden');

        if (data.error) {
            alert('Error generating fix: ' + data.error);
        } else if (data.corrected_code) {
            // Reload fixes to include the new one
            await loadFixes();
            currentFixIndex = 0;  // New fix is at index 0 (most recent)
            displayCurrentFix();

            // Show reasoning if available (agent fix)
            if (data.reasoning && data.reasoning.length > 0) {
                console.log('Agent fix reasoning:', data.reasoning);
                const reasoningMsg = `Agent Fix completed in ${data.iterations || data.reasoning.length} iterations:\n` +
                    data.reasoning.map((r, i) => `${i+1}. ${r}`).join('\n');
                addMessage('assistant', reasoningMsg);
            }
        } else {
            alert('No fix was generated. The model may need more context.');
        }
    } catch (err) {
        loading.classList.add('hidden');
        alert('Error: ' + err.message);
    }

    quickBtn.disabled = false;
    agentBtn.disabled = false;
}

function addMessage(role, content, save = true) {
    const messagesDiv = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'flex gap-3 chat-message';

    if (role === 'user') {
        messageDiv.innerHTML = `
            <div class="flex-1 flex justify-end">
                <div class="bg-blue-600 rounded-lg p-3 max-w-[80%]">
                    <p class="text-sm text-white whitespace-pre-wrap">${escapeHtml(content)}</p>
                </div>
            </div>
            <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center shrink-0">
                <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center shrink-0">
                <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
            </div>
            <div class="flex-1">
                <div class="bg-gray-800 rounded-lg p-3 border border-gray-700 max-w-[90%]">
                    <div class="text-sm text-gray-300 whitespace-pre-wrap prose prose-invert prose-sm max-w-none">${formatMarkdown(content)}</div>
                </div>
            </div>
        `;
    }

    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    // Highlight any code blocks in the response
    messageDiv.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
    });
}

function addLoadingIndicator() {
    const messagesDiv = document.getElementById('chat-messages');
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-indicator';
    loadingDiv.className = 'flex gap-3';
    loadingDiv.innerHTML = `
        <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center shrink-0">
            <svg class="w-4 h-4 text-blue-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
        </div>
        <div class="flex-1">
            <div class="bg-gray-800 rounded-lg p-3 border border-gray-700">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                    <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                    <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                </div>
            </div>
        </div>
    `;
    messagesDiv.appendChild(loadingDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function removeLoadingIndicator() {
    const loading = document.getElementById('loading-indicator');
    if (loading) loading.remove();
}

async function sendMessage(event) {
    if (event) event.preventDefault();

    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (!message) return;

    // Track last user message for retry functionality
    lastUserMessage = message;
    input.value = '';
    addMessage('user', message);
    chatHistory.push({ role: 'user', content: message });
    saveChatHistory();

    // Disable input while processing
    const sendBtn = document.getElementById('send-btn');
    input.disabled = true;
    sendBtn.disabled = true;
    addLoadingIndicator();

    try {
        const modelSelect = document.getElementById('chat-model-select');
        const modelId = modelSelect.value || null;

        const response = await fetch(`/finding/${findingId}/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: message,
                history: chatHistory.slice(-10), // Send last 10 messages for context
                model_id: modelId
            })
        });

        const data = await response.json();
        removeLoadingIndicator();

        if (data.error) {
            addMessage('assistant', 'Sorry, I encountered an error: ' + data.error);
        } else {
            addMessage('assistant', data.response);
            chatHistory.push({ role: 'assistant', content: data.response });
            saveChatHistory();
        }
        updateRetryButton();
    } catch (err) {
        removeLoadingIndicator();
        addMessage('assistant', 'Sorry, I encountered an error connecting to the server.');
        updateRetryButton();
    }

    input.disabled = false;
    sendBtn.disabled = false;
    input.focus();
}

function askQuestion(question) {
    document.getElementById('chat-input').value = question;
    sendMessage();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatMarkdown(text) {
    // Basic markdown formatting with syntax highlighting support
    return text
        // Code blocks with language detection
        .replace(/```(\w*)\n([\s\S]*?)```/g, function(match, lang, code) {
            const language = lang || 'plaintext';
            return `<pre class="bg-gray-900 p-2 rounded mt-2 mb-2 overflow-x-auto"><code class="language-${language}">${escapeHtml(code.trim())}</code></pre>`;
        })
        // Inline code
        .replace(/`([^`]+)`/g, '<code class="bg-gray-900 px-1 rounded text-blue-300">$1</code>')
        // Bold
        .replace(/\*\*([^*]+)\*\*/g, '<strong class="text-white">$1</strong>')
        // Headers
        .replace(/^### (.+)$/gm, '<h3 class="text-white font-semibold mt-3 mb-1">$1</h3>')
        .replace(/^## (.+)$/gm, '<h2 class="text-white font-semibold text-lg mt-3 mb-1">$1</h2>')
        // Lists
        .replace(/^- (.+)$/gm, '<li class="ml-4">$1</li>')
        .replace(/^(\d+)\. (.+)$/gm, '<li class="ml-4">$2</li>');
}
</script>
{% endblock %}
