{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
{% endblock %}

{% block content %}
<style>
    .log-row { cursor: pointer; }
    .log-row:hover { background: rgba(59, 130, 246, 0.1); }
    .log-detail { display: none; }
    .log-detail.active { display: block; }
    .response-content { white-space: pre-wrap; font-family: monospace; font-size: 0.8rem; max-height: 400px; overflow-y: auto; }
    .prompt-content { white-space: pre-wrap; font-family: monospace; font-size: 0.8rem; max-height: 300px; overflow-y: auto; }
</style>

<div class="min-h-screen bg-gray-900 text-gray-100">
    <!-- Header -->
    <div class="bg-gray-800/50 border-b border-gray-700/50 px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="/" class="text-gray-400 hover:text-gray-200 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                </a>
                <h1 class="text-xl font-semibold text-gray-100">LLM Request Logs</h1>
                <span class="text-sm text-gray-500">Debug parsing issues</span>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="loadStats()" class="px-3 py-1.5 text-xs font-medium text-gray-300 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                    Refresh Stats
                </button>
                <button onclick="clearOldLogs()" class="px-3 py-1.5 text-xs font-medium text-red-300 bg-red-500/20 hover:bg-red-500/30 border border-red-500/30 rounded-lg transition-colors">
                    Clear Old Logs
                </button>
            </div>
        </div>
    </div>

    <div class="flex h-[calc(100vh-65px)]">
        <!-- Sidebar - Filters & Stats -->
        <div class="w-72 bg-gray-800/30 border-r border-gray-700/50 p-4 overflow-y-auto">
            <!-- Stats -->
            <div id="stats-panel" class="mb-6">
                <h3 class="text-sm font-medium text-gray-400 mb-3">Statistics</h3>
                <div class="space-y-2 text-sm" id="stats-content">
                    <div class="text-gray-500">Loading...</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="space-y-4">
                <h3 class="text-sm font-medium text-gray-400">Filters</h3>

                <div>
                    <label class="text-xs text-gray-500">Scan ID</label>
                    <input type="number" id="filter-scan-id" placeholder="All scans"
                        class="w-full mt-1 px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-sm text-gray-200 focus:border-blue-500 focus:outline-none">
                </div>

                <div>
                    <label class="text-xs text-gray-500">Phase</label>
                    <select id="filter-phase" class="w-full mt-1 px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-sm text-gray-200 focus:border-blue-500 focus:outline-none">
                        <option value="">All phases</option>
                        <option value="scanner">Scanner</option>
                        <option value="verifier">Verifier</option>
                        <option value="enricher">Enricher</option>
                        <option value="chat">Chat</option>
                        <option value="cleanup">Cleanup</option>
                        <option value="mr_review">MR Review</option>
                    </select>
                </div>

                <div>
                    <label class="text-xs text-gray-500">Model</label>
                    <input type="text" id="filter-model" placeholder="All models"
                        class="w-full mt-1 px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-sm text-gray-200 focus:border-blue-500 focus:outline-none">
                </div>

                <div>
                    <label class="text-xs text-gray-500">Parse Status</label>
                    <select id="filter-parse-success" class="w-full mt-1 px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-sm text-gray-200 focus:border-blue-500 focus:outline-none">
                        <option value="">All</option>
                        <option value="true">Success</option>
                        <option value="false">Failed</option>
                    </select>
                </div>

                <button onclick="loadLogs()" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
                    Apply Filters
                </button>
            </div>

            <!-- Recent Scans -->
            <div class="mt-6" id="recent-scans-panel">
                <h3 class="text-sm font-medium text-gray-400 mb-3">Recent Scans</h3>
                <div class="space-y-1" id="recent-scans-content">
                    <div class="text-gray-500 text-sm">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Log List -->
            <div class="flex-1 overflow-y-auto p-4" id="logs-container">
                <div class="text-gray-500 text-center py-8">Loading logs...</div>
            </div>
        </div>

        <!-- Detail Panel -->
        <div class="w-[600px] bg-gray-800/30 border-l border-gray-700/50 overflow-y-auto" id="detail-panel">
            <div class="p-6 text-center text-gray-500">
                <svg class="w-12 h-12 mx-auto mb-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p>Select a log entry to view details</p>
            </div>
        </div>
    </div>
</div>

<script>
let currentOffset = 0;
const limit = 50;

async function loadStats() {
    try {
        const response = await fetch('/llm-logs/stats');
        const stats = await response.json();

        document.getElementById('stats-content').innerHTML = `
            <div class="flex justify-between"><span class="text-gray-400">Total Logs:</span><span class="text-gray-200">${stats.total}</span></div>
            <div class="flex justify-between"><span class="text-gray-400">Failed Parses:</span><span class="${stats.failed_parses > 0 ? 'text-red-400' : 'text-green-400'}">${stats.failed_parses}</span></div>
            <div class="flex justify-between"><span class="text-gray-400">Success Rate:</span><span class="text-gray-200">${stats.success_rate}%</span></div>
            <hr class="border-gray-700 my-2">
            <div class="text-xs text-gray-500 mt-2">By Phase:</div>
            ${Object.entries(stats.by_phase).map(([phase, count]) =>
                `<div class="flex justify-between text-xs"><span class="text-gray-400">${phase}:</span><span class="text-gray-300">${count}</span></div>`
            ).join('')}
            <div class="text-xs text-gray-500 mt-2">By Model:</div>
            ${Object.entries(stats.by_model).map(([model, count]) =>
                `<div class="flex justify-between text-xs"><span class="text-gray-400 truncate max-w-[120px]" title="${model}">${model}:</span><span class="text-gray-300">${count}</span></div>`
            ).join('')}
        `;

        // Update recent scans
        document.getElementById('recent-scans-content').innerHTML = stats.recent_scans.length > 0
            ? stats.recent_scans.map(s =>
                `<button onclick="filterByScan(${s.scan_id})" class="w-full text-left px-2 py-1 text-xs text-gray-400 hover:text-gray-200 hover:bg-gray-700/50 rounded transition-colors">
                    Scan #${s.scan_id} <span class="text-gray-500">(${s.log_count} logs)</span>
                </button>`
            ).join('')
            : '<div class="text-gray-500 text-sm">No scans with logs</div>';

    } catch (e) {
        console.error('Failed to load stats:', e);
    }
}

function filterByScan(scanId) {
    document.getElementById('filter-scan-id').value = scanId;
    loadLogs();
}

async function loadLogs() {
    currentOffset = 0;
    await fetchLogs();
}

async function fetchLogs() {
    const scanId = document.getElementById('filter-scan-id').value;
    const phase = document.getElementById('filter-phase').value;
    const model = document.getElementById('filter-model').value;
    const parseSuccess = document.getElementById('filter-parse-success').value;

    const params = new URLSearchParams();
    if (scanId) params.append('scan_id', scanId);
    if (phase) params.append('phase', phase);
    if (model) params.append('model', model);
    if (parseSuccess) params.append('parse_success', parseSuccess);
    params.append('limit', limit);
    params.append('offset', currentOffset);

    try {
        const response = await fetch(`/llm-logs/list?${params}`);
        const data = await response.json();

        const container = document.getElementById('logs-container');

        if (data.logs.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <svg class="w-12 h-12 mx-auto mb-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p>No logs found</p>
                    <p class="text-sm mt-1">Run a scan to generate LLM request logs</p>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <div class="mb-4 flex justify-between items-center">
                <span class="text-sm text-gray-400">Showing ${data.offset + 1}-${data.offset + data.logs.length} of ${data.total} logs</span>
                <div class="flex gap-2">
                    ${data.offset > 0 ? `<button onclick="prevPage()" class="px-3 py-1 text-xs bg-gray-700 hover:bg-gray-600 rounded">Previous</button>` : ''}
                    ${data.offset + data.logs.length < data.total ? `<button onclick="nextPage()" class="px-3 py-1 text-xs bg-gray-700 hover:bg-gray-600 rounded">Next</button>` : ''}
                </div>
            </div>
            <div class="space-y-2">
                ${data.logs.map(log => `
                    <div class="log-row bg-gray-800/50 border border-gray-700/50 rounded-lg p-3 ${!log.parse_success ? 'border-l-4 border-l-red-500' : ''}"
                         onclick="showLogDetail(${log.id})">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-mono text-gray-500">#${log.id}</span>
                                ${log.scan_id ? `<span class="text-xs bg-blue-500/20 text-blue-400 px-1.5 py-0.5 rounded">Scan ${log.scan_id}</span>` : ''}
                                <span class="text-xs bg-gray-700 text-gray-300 px-1.5 py-0.5 rounded">${log.phase}</span>
                                <span class="text-xs text-gray-400 truncate max-w-[200px]" title="${log.model_name}">${log.model_name}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                ${log.parse_success
                                    ? `<span class="text-xs text-green-400">OK</span>`
                                    : `<span class="text-xs text-red-400">Parse Failed</span>`
                                }
                                ${log.duration_ms ? `<span class="text-xs text-gray-500">${(log.duration_ms/1000).toFixed(1)}s</span>` : ''}
                                <span class="text-xs text-gray-500">${new Date(log.created_at).toLocaleTimeString()}</span>
                            </div>
                        </div>
                        ${log.file_path ? `<div class="text-xs text-gray-500 mb-1 truncate">${log.file_path}</div>` : ''}
                        <div class="text-xs text-gray-400 truncate">${escapeHtml(log.response_preview || 'No response')}</div>
                    </div>
                `).join('')}
            </div>
        `;

    } catch (e) {
        console.error('Failed to load logs:', e);
        document.getElementById('logs-container').innerHTML = `
            <div class="text-center py-8 text-red-400">Failed to load logs: ${e.message}</div>
        `;
    }
}

function nextPage() {
    currentOffset += limit;
    fetchLogs();
}

function prevPage() {
    currentOffset = Math.max(0, currentOffset - limit);
    fetchLogs();
}

async function showLogDetail(logId) {
    try {
        const response = await fetch(`/llm-logs/${logId}`);
        const log = await response.json();

        document.getElementById('detail-panel').innerHTML = `
            <div class="p-4 border-b border-gray-700/50">
                <div class="flex items-center justify-between">
                    <h3 class="font-medium text-gray-200">Log #${log.id}</h3>
                    <span class="${log.parse_success ? 'text-green-400' : 'text-red-400'} text-sm">
                        ${log.parse_success ? 'Parse Success' : 'Parse Failed'}
                    </span>
                </div>
            </div>

            <div class="p-4 space-y-4">
                <!-- Metadata -->
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div><span class="text-gray-500">Scan ID:</span> <span class="text-gray-300">${log.scan_id || 'N/A'}</span></div>
                    <div><span class="text-gray-500">Phase:</span> <span class="text-gray-300">${log.phase}</span></div>
                    <div><span class="text-gray-500">Model:</span> <span class="text-gray-300 text-xs">${log.model_name}</span></div>
                    <div><span class="text-gray-500">Analyzer:</span> <span class="text-gray-300">${log.analyzer_name || 'N/A'}</span></div>
                    <div><span class="text-gray-500">Duration:</span> <span class="text-gray-300">${log.duration_ms ? (log.duration_ms/1000).toFixed(2) + 's' : 'N/A'}</span></div>
                    <div><span class="text-gray-500">Tokens:</span> <span class="text-gray-300">${log.tokens_in || '?'}/${log.tokens_out || '?'}</span></div>
                </div>

                ${log.file_path ? `<div class="text-sm"><span class="text-gray-500">File:</span> <span class="text-gray-300 text-xs font-mono">${log.file_path}</span></div>` : ''}

                ${log.parse_error ? `
                    <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-3">
                        <div class="text-sm font-medium text-red-400 mb-1">Parse Error</div>
                        <div class="text-xs text-red-300 font-mono">${escapeHtml(log.parse_error)}</div>
                    </div>
                ` : ''}

                <!-- Request Prompt -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-sm font-medium text-gray-400">Request Prompt</h4>
                        <button onclick="copyToClipboard('request-prompt')" class="text-xs text-blue-400 hover:text-blue-300">Copy</button>
                    </div>
                    <div id="request-prompt" class="prompt-content bg-gray-900 border border-gray-700 rounded-lg p-3 text-gray-300">${escapeHtml(log.request_prompt || 'No prompt')}</div>
                </div>

                <!-- Raw Response -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-sm font-medium text-gray-400">Raw Response</h4>
                        <button onclick="copyToClipboard('raw-response')" class="text-xs text-blue-400 hover:text-blue-300">Copy</button>
                    </div>
                    <div id="raw-response" class="response-content bg-gray-900 border border-gray-700 rounded-lg p-3 text-gray-300">${escapeHtml(log.raw_response || 'No response')}</div>
                </div>

                ${log.parsed_result ? `
                    <div>
                        <h4 class="text-sm font-medium text-gray-400 mb-2">Parsed Result</h4>
                        <pre class="bg-gray-900 border border-gray-700 rounded-lg p-3 text-xs text-gray-300 overflow-x-auto">${escapeHtml(JSON.stringify(log.parsed_result, null, 2))}</pre>
                    </div>
                ` : ''}
            </div>
        `;

    } catch (e) {
        console.error('Failed to load log detail:', e);
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.textContent;
    navigator.clipboard.writeText(text);
}

async function clearOldLogs() {
    const days = prompt('Clear logs older than how many days?', '7');
    if (!days) return;

    if (!confirm(`This will delete all logs older than ${days} days. Continue?`)) return;

    try {
        const response = await fetch(`/llm-logs?older_than_days=${days}`, { method: 'DELETE' });
        const result = await response.json();
        alert(`Deleted ${result.deleted} logs`);
        loadStats();
        loadLogs();
    } catch (e) {
        alert('Failed to clear logs: ' + e.message);
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadLogs();
});
</script>
{% endblock %}
