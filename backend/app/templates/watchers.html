{% extends "base.html" %}

{% block content %}
<div class="p-6 h-full overflow-auto custom-scrollbar">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold text-white">Repository Watchers</h1>
                <p class="text-gray-400 text-sm mt-1">Automatically scan merge requests and pull requests for security vulnerabilities</p>
            </div>
            <button onclick="document.getElementById('add-watcher-modal').classList.remove('hidden')"
                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center gap-2 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Add Watcher
            </button>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div class="text-2xl font-bold text-white">{{ watchers|length }}</div>
                <div class="text-sm text-gray-400">Total Watchers</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div class="text-2xl font-bold text-green-400">{{ watchers|selectattr('status', 'equalto', 'running')|list|length }}</div>
                <div class="text-sm text-gray-400">Running</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div class="text-2xl font-bold text-yellow-400">{{ watchers|selectattr('status', 'equalto', 'paused')|list|length }}</div>
                <div class="text-sm text-gray-400">Paused</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div class="text-2xl font-bold text-red-400">{{ watchers|selectattr('status', 'equalto', 'error')|list|length }}</div>
                <div class="text-sm text-gray-400">Error</div>
            </div>
        </div>

        <!-- Watchers Table -->
        <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
            <table class="w-full">
                <thead class="bg-gray-900/50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Name</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Project</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Profile</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Last Check</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Reviews</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="watchers-list" class="divide-y divide-gray-700">
                    {% for watcher in watchers %}
                    {% include "partials/watcher_row.html" %}
                    {% endfor %}
                </tbody>
            </table>

            {% if not watchers %}
            <div class="p-8 text-center text-gray-500">
                <svg class="w-12 h-12 mx-auto mb-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                </svg>
                <p class="text-sm">No watchers configured yet</p>
                <p class="text-xs mt-1">Add a watcher to start monitoring GitLab MRs</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Watcher Modal -->
<div id="add-watcher-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-white">Add Repository Watcher</h2>
            <button onclick="document.getElementById('add-watcher-modal').classList.add('hidden')"
                class="text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <form hx-post="/watchers" hx-target="#watchers-list" hx-swap="innerHTML"
              hx-on::after-request="if(event.detail.successful) { document.getElementById('add-watcher-modal').classList.add('hidden'); location.reload(); }">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Watcher Name *</label>
                    <input type="text" name="name" required
                        class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="e.g., Main Project Watcher">
                </div>

                <!-- Provider Toggle -->
                <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Repository Type</label>
                    <div class="flex gap-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="provider" value="gitlab" checked onchange="toggleAddWatcherProvider('gitlab')"
                                class="w-4 h-4 text-orange-500 bg-gray-700 border-gray-600 focus:ring-orange-500">
                            <span class="ml-2 text-sm text-gray-300">
                                <span class="font-medium text-orange-400">Internal</span> (GitLab)
                            </span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="provider" value="github" onchange="toggleAddWatcherProvider('github')"
                                class="w-4 h-4 text-green-500 bg-gray-700 border-gray-600 focus:ring-green-500">
                            <span class="ml-2 text-sm text-gray-300">
                                <span class="font-medium text-green-400">External</span> (GitHub)
                            </span>
                        </label>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Internal: Self-hosted GitLab for private repos. External: Public GitHub repos.</p>
                </div>

                <!-- GitLab Fields -->
                <div id="add-watcher-gitlab-section">
                    <!-- Saved GitLab Repo Selection -->
                    {% if gitlab_repos %}
                    <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700 mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Saved GitLab Repository</label>
                        <select name="gitlab_repo_id" id="add-watcher-repo-id" onchange="selectAddWatcherRepo(this.value)"
                            class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Select a saved repo or enter manually --</option>
                            {% for repo in gitlab_repos %}
                            <option value="{{ repo.id }}">{{ repo.name }} ({{ repo.project_id }})</option>
                            {% endfor %}
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Select a saved repo to auto-fill connection details</p>
                    </div>
                    {% endif %}

                    <div id="add-watcher-gitlab-manual-fields" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">GitLab URL</label>
                            <input type="text" name="gitlab_url" id="add-watcher-url" value="https://192.168.33.158"
                                class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="https://gitlab.com">
                            <p class="text-xs text-gray-500 mt-1">Use your self-hosted GitLab URL if applicable</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Access Token <span id="add-watcher-token-req">*</span></label>
                            <input type="password" name="gitlab_token" id="add-watcher-token"
                                class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="glpat-xxxxxxxxxxxx">
                            <p class="text-xs text-gray-500 mt-1">Personal access token with api scope</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Project ID/Path <span id="add-watcher-project-req">*</span></label>
                            <input type="text" name="project_id" id="add-watcher-project"
                                class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="12345 or group/project">
                            <p class="text-xs text-gray-500 mt-1">Numeric ID or full path like "mygroup/myproject"</p>
                        </div>
                    </div>
                </div>

                <!-- GitHub Fields (hidden by default) -->
                <div id="add-watcher-github-section" class="hidden">
                    <!-- Saved GitHub Repo Selection -->
                    {% if github_repos %}
                    <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700 mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Saved GitHub Repository</label>
                        <select name="github_repo_id" id="add-watcher-github-repo-id" onchange="selectAddWatcherGitHubRepo(this.value)"
                            class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Select a saved repo or enter manually --</option>
                            {% for repo in github_repos %}
                            <option value="{{ repo.id }}">{{ repo.name }} ({{ repo.owner }}/{{ repo.repo }})</option>
                            {% endfor %}
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Select a saved repo to auto-fill connection details</p>
                    </div>
                    {% endif %}

                    <div id="add-watcher-github-manual-fields" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">GitHub API URL</label>
                            <input type="text" name="github_url" id="add-watcher-github-url" value="https://api.github.com"
                                class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="https://api.github.com">
                            <p class="text-xs text-gray-500 mt-1">Use default for github.com or your GitHub Enterprise URL</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">GitHub Token <span id="add-watcher-github-token-req">*</span></label>
                            <input type="password" name="github_token" id="add-watcher-github-token"
                                class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="ghp_xxxxxxxxxxxx">
                            <p class="text-xs text-gray-500 mt-1">Personal access token with repo scope (or fine-grained token)</p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Repository Owner <span class="text-red-400">*</span></label>
                                <input type="text" name="github_owner" id="add-watcher-github-owner"
                                    class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="torvalds">
                                <p class="text-xs text-gray-500 mt-1">User or organization</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Repository Name <span class="text-red-400">*</span></label>
                                <input type="text" name="github_repo_name" id="add-watcher-github-repo"
                                    class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="linux">
                                <p class="text-xs text-gray-500 mt-1">Repository name</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Branch Filter</label>
                        <input type="text" name="branch_filter"
                            class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="main|develop">
                        <p class="text-xs text-gray-500 mt-1">Regex for target branches</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Label Filter</label>
                        <input type="text" name="label_filter"
                            class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="security-review">
                        <p class="text-xs text-gray-500 mt-1">Comma-separated labels</p>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Scan Profile</label>
                    <select name="scan_profile_id"
                        class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        {% for profile in profiles %}
                        <option value="{{ profile.id }}" {% if profile.name == 'Quick Scan' %}selected{% endif %}>{{ profile.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Poll Interval (seconds)</label>
                        <input type="number" name="poll_interval" value="300" min="60" max="86400"
                            class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Default: 300 (5 min)</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Max Files to Review</label>
                        <input type="number" name="max_files_to_review" value="100" min="1" max="1000"
                            class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Skip MRs with more files</p>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">MR Lookback (days)</label>
                    <input type="number" name="mr_lookback_days" value="7" min="0" max="365"
                        class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Only review MRs created in the last N days (0 = no limit)</p>
                </div>

                <!-- Post Comments Toggle -->
                <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" name="post_comments" value="true"
                            class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500 mr-3">
                        <div>
                            <span class="text-sm font-medium text-gray-300">Post comments to GitLab</span>
                            <p class="text-xs text-gray-500 mt-0.5">When enabled, findings will be posted as inline comments on MRs. When disabled, findings are only tracked locally (dry run mode for testing).</p>
                        </div>
                    </label>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-6">
                <button type="button" onclick="document.getElementById('add-watcher-modal').classList.add('hidden')"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors">
                    Cancel
                </button>
                <button type="submit"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                    Create Watcher
                </button>
            </div>
        </form>
    </div>
</div>

<!-- View Reviews Modal -->
<div id="reviews-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-white">MR Reviews</h2>
            <button onclick="document.getElementById('reviews-modal').classList.add('hidden')"
                class="text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="reviews-content">
            <!-- Reviews will be loaded here via HTMX -->
            <div class="text-center py-8 text-gray-500">Loading reviews...</div>
        </div>
    </div>
</div>

<!-- Edit Watcher Modal -->
<div id="edit-watcher-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-white">Edit Watcher</h2>
            <button onclick="document.getElementById('edit-watcher-modal').classList.add('hidden')"
                class="text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <form id="edit-watcher-form" onsubmit="submitEditWatcher(event)">
            <input type="hidden" name="watcher_id" id="edit-watcher-id">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Watcher Name</label>
                    <input type="text" name="name" id="edit-watcher-name" required
                        class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Saved Repo Selection -->
                {% if gitlab_repos %}
                <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Saved Repository</label>
                    <select name="gitlab_repo_id" id="edit-watcher-repo-id" onchange="selectEditWatcherRepo(this.value)"
                        class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Enter manually --</option>
                        {% for repo in gitlab_repos %}
                        <option value="{{ repo.id }}">{{ repo.name }} ({{ repo.project_id }})</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}

                <div id="edit-watcher-manual-fields">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">GitLab URL</label>
                            <input type="text" name="gitlab_url" id="edit-watcher-url"
                                class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Access Token</label>
                            <input type="password" name="gitlab_token" id="edit-watcher-token"
                                class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Leave empty to keep current">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Project ID/Path</label>
                            <input type="text" name="project_id" id="edit-watcher-project"
                                class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Branch Filter</label>
                        <input type="text" name="branch_filter" id="edit-watcher-branch"
                            class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Poll Interval</label>
                        <input type="number" name="poll_interval" id="edit-watcher-interval" min="60"
                            class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Max Files to Review</label>
                        <input type="number" name="max_files_to_review" id="edit-watcher-max-files" min="1" max="1000"
                            class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">MRs with more files will be skipped</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Scan Profile</label>
                        <select name="scan_profile_id" id="edit-watcher-profile"
                            class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            {% for profile in profiles %}
                            <option value="{{ profile.id }}" {% if profile.name == 'Quick Scan' %}selected{% endif %}>{{ profile.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">MR Lookback (days)</label>
                    <input type="number" name="mr_lookback_days" id="edit-watcher-lookback" min="0" max="365"
                        class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Only review MRs created in the last N days (0 = no limit)</p>
                </div>

                <!-- Post Comments Toggle -->
                <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" name="post_comments" id="edit-watcher-post-comments" value="true"
                            class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500 mr-3">
                        <div>
                            <span class="text-sm font-medium text-gray-300">Post comments to GitLab</span>
                            <p class="text-xs text-gray-500 mt-0.5">When enabled, findings will be posted as inline comments on MRs.</p>
                        </div>
                    </label>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" onclick="document.getElementById('edit-watcher-modal').classList.add('hidden')"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors">Cancel</button>
                <button type="submit"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
// Saved GitLab repos data for auto-fill
const savedGitLabRepos = {
    {% for repo in gitlab_repos %}
    {{ repo.id }}: {
        gitlab_url: "{{ repo.gitlab_url }}",
        project_id: "{{ repo.project_id }}"
    },
    {% endfor %}
};

// Saved GitHub repos data for auto-fill
const savedGitHubRepos = {
    {% for repo in github_repos %}
    {{ repo.id }}: {
        github_url: "{{ repo.github_url }}",
        owner: "{{ repo.owner }}",
        repo: "{{ repo.repo }}"
    },
    {% endfor %}
};

// Alias for backwards compatibility
const savedRepos = savedGitLabRepos;

// Store watcher data for editing
const watchersData = {
    {% for watcher in watchers %}
    {{ watcher.id }}: {
        name: "{{ watcher.name }}",
        provider: "{{ watcher.provider or 'gitlab' }}",
        gitlab_url: "{{ watcher.gitlab_url or '' }}",
        project_id: "{{ watcher.project_id or '' }}",
        github_url: "{{ watcher.github_url or 'https://api.github.com' }}",
        github_owner: "{{ watcher.github_owner or '' }}",
        github_repo_name: "{{ watcher.github_repo_name or '' }}",
        branch_filter: "{{ watcher.branch_filter or '' }}",
        poll_interval: {{ watcher.poll_interval }},
        post_comments: {{ 'true' if watcher.post_comments else 'false' }},
        scan_profile_id: {{ watcher.scan_profile_id or 'null' }},
        gitlab_repo_id: {{ watcher.gitlab_repo_id or 'null' }},
        github_repo_id: {{ watcher.github_repo_id or 'null' }},
        max_files_to_review: {{ watcher.max_files_to_review or 100 }},
        mr_lookback_days: {{ watcher.mr_lookback_days if watcher.mr_lookback_days is not none else 7 }}
    },
    {% endfor %}
};

// Toggle provider sections in add modal
function toggleAddWatcherProvider(provider) {
    const gitlabSection = document.getElementById('add-watcher-gitlab-section');
    const githubSection = document.getElementById('add-watcher-github-section');

    if (provider === 'github') {
        gitlabSection.classList.add('hidden');
        githubSection.classList.remove('hidden');
    } else {
        gitlabSection.classList.remove('hidden');
        githubSection.classList.add('hidden');
    }
}

// Toggle provider sections in edit modal
function toggleEditWatcherProvider(provider) {
    const gitlabSection = document.getElementById('edit-watcher-gitlab-section');
    const githubSection = document.getElementById('edit-watcher-github-section');

    if (provider === 'github') {
        gitlabSection.classList.add('hidden');
        githubSection.classList.remove('hidden');
    } else {
        gitlabSection.classList.remove('hidden');
        githubSection.classList.add('hidden');
    }
}

// Select saved GitHub repo in add modal
function selectAddWatcherGitHubRepo(repoId) {
    const urlField = document.getElementById('add-watcher-github-url');
    const ownerField = document.getElementById('add-watcher-github-owner');
    const repoField = document.getElementById('add-watcher-github-repo');
    const tokenField = document.getElementById('add-watcher-github-token');
    const tokenReq = document.getElementById('add-watcher-github-token-req');

    if (repoId && savedGitHubRepos[repoId]) {
        const repo = savedGitHubRepos[repoId];
        urlField.value = repo.github_url;
        ownerField.value = repo.owner;
        repoField.value = repo.repo;
        tokenField.value = '';
        tokenField.placeholder = 'Using saved token';
        if (tokenReq) tokenReq.style.display = 'none';
    } else {
        urlField.value = 'https://api.github.com';
        ownerField.value = '';
        repoField.value = '';
        tokenField.value = '';
        tokenField.placeholder = 'ghp_xxxxxxxxxxxx';
        if (tokenReq) tokenReq.style.display = '';
    }
}

function selectAddWatcherRepo(repoId) {
    const urlField = document.getElementById('add-watcher-url');
    const tokenField = document.getElementById('add-watcher-token');
    const projectField = document.getElementById('add-watcher-project');
    const tokenReq = document.getElementById('add-watcher-token-req');
    const projectReq = document.getElementById('add-watcher-project-req');

    if (repoId && savedRepos[repoId]) {
        const repo = savedRepos[repoId];
        urlField.value = repo.gitlab_url;
        projectField.value = repo.project_id;
        tokenField.value = '';
        tokenField.placeholder = 'Using saved token';
        tokenReq.style.display = 'none';
        projectReq.style.display = 'none';
    } else {
        urlField.value = 'https://192.168.33.158';
        tokenField.value = '';
        projectField.value = '';
        tokenField.placeholder = 'glpat-xxxxxxxxxxxx';
        tokenReq.style.display = '';
        projectReq.style.display = '';
    }
}

function selectEditWatcherRepo(repoId) {
    const urlField = document.getElementById('edit-watcher-url');
    const tokenField = document.getElementById('edit-watcher-token');
    const projectField = document.getElementById('edit-watcher-project');

    if (repoId && savedRepos[repoId]) {
        const repo = savedRepos[repoId];
        urlField.value = repo.gitlab_url;
        projectField.value = repo.project_id;
        tokenField.value = '';
        tokenField.placeholder = 'Using saved token';
    } else {
        tokenField.placeholder = 'Leave empty to keep current';
    }
}

function editWatcher(id) {
    const w = watchersData[id];
    if (!w) return;

    document.getElementById('edit-watcher-id').value = id;
    document.getElementById('edit-watcher-name').value = w.name;
    document.getElementById('edit-watcher-url').value = w.gitlab_url;
    document.getElementById('edit-watcher-project').value = w.project_id;
    document.getElementById('edit-watcher-branch').value = w.branch_filter;
    document.getElementById('edit-watcher-interval').value = w.poll_interval;
    document.getElementById('edit-watcher-post-comments').checked = w.post_comments;
    document.getElementById('edit-watcher-profile').value = w.scan_profile_id || '';
    document.getElementById('edit-watcher-max-files').value = w.max_files_to_review || 100;
    document.getElementById('edit-watcher-lookback').value = w.mr_lookback_days !== undefined ? w.mr_lookback_days : 7;

    // Set saved repo dropdown if exists
    const repoSelect = document.getElementById('edit-watcher-repo-id');
    if (repoSelect) {
        repoSelect.value = w.gitlab_repo_id || '';
    }

    document.getElementById('edit-watcher-modal').classList.remove('hidden');
}

async function submitEditWatcher(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const id = formData.get('watcher_id');

    try {
        const response = await fetch(`/watchers/${id}`, {
            method: 'PUT',
            body: formData
        });
        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to update watcher');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

async function deleteWatcher(id, name) {
    if (!confirm(`Delete watcher "${name}"? This will also delete all associated reviews.`)) return;

    try {
        const response = await fetch(`/watchers/${id}`, { method: 'DELETE' });
        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to delete watcher');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

function viewReviews(watcherId) {
    document.getElementById('reviews-content').innerHTML = '<div class="text-center py-8 text-gray-500">Loading reviews...</div>';
    document.getElementById('reviews-modal').classList.remove('hidden');

    // Fetch reviews
    htmx.ajax('GET', `/watchers/${watcherId}/reviews`, {target: '#reviews-content', swap: 'innerHTML'});
}

async function pollNow(id) {
    try {
        const response = await fetch(`/watchers/${id}/poll`, { method: 'POST' });
        const data = await response.json();
        if (response.ok) {
            alert('Poll task queued successfully');
        } else {
            alert(data.error || 'Failed to queue poll');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}
</script>
{% endblock %}
